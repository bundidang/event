<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitor Registration (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Prompt', sans-serif !important; }
    body{ background:#f7f9fb }
    /* สไตล์สำหรับปุ่มที่เป็นตัวนับ */
    .count-button {
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      border: 2px solid transparent;
      outline: none;
    }
    .count-button:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    .count-button.active {
      border-color: rgba(79, 70, 229, 0.8); /* สีน้ำเงินเข้มสำหรับสถานะ Active (Invited) */
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    .count-button.active.red {
      border-color: rgba(220, 38, 38, 0.8); /* Guest */
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
    }
    .count-button.active.green {
      border-color: rgba(22, 163, 74, 0.8); /* Total Checked-In */
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.3);
    }
    
    /* สไตล์เฉพาะสำหรับไอคอนโทรศัพท์วงกลมดำ */
    .phone-icon-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: black;
        border-radius: 50%;
        width: 1.5rem; /* h-6 w-6 */
        height: 1.5rem;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.1); 
        flex-shrink: 0; 
    }
    .phone-icon-circle svg {
        fill: white; 
        width: 0.875rem; /* h-3.5 w-3.5 */
        height: 0.875rem;
    }
    .phone-icon-anchor:hover .phone-icon-circle {
        background-color: #4f46e5; 
    }
    .phone-icon-anchor:hover span {
        color: #4f46e5; 
    }

    /* ซ่อนปุ่ม Print Label บนหน้าจอขนาดเล็กกว่า md (มือถือ) */
    .print-button {
        display: block; 
    }
    @media (max-width: 767px) { 
        .print-button {
            display: none !important; 
        }
    }
    
    /* NEW: สไตล์สำหรับจัดช่องว่างของ Date/Time (1 เคาะรอบ |) */
    .datetime-group {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af; /* text-gray-400 */
        font-size: 0.75rem; /* text-xs */
        /* ทำให้ text-align: center ใช้ได้เมื่ออยู่บนมือถือ */
        width: 100%; 
    }
    .datetime-group > span {
        display: inline-flex;
        align-items: center;
        white-space: nowrap; 
    }
    .datetime-group .separator {
        margin: 0 0.25rem; /* ช่องว่าง 1 เคาะ */
        color: #e5e7eb; /* border-gray-200 */
        font-weight: 300;
    }

    /* NEW: การจัดองค์ประกอบด้านขวา (ป้ายสถานะ, วันเวลา, ปุ่ม) ให้อยู่ตรงกลางบนมือถือ */
    .right-content-area {
        display: flex; /* ใช้ flex เพื่อจัดองค์ประกอบย่อย */
        flex-direction: column; /* เรียงเป็นคอลัมน์ */
        align-items: flex-end; /* จัดชิดขวาตามค่า default สำหรับ desktop */
        flex-shrink: 0;
    }

    @media (max-width: 767px) { /* สำหรับหน้าจอขนาดเล็ก (มือถือ) */
        .right-content-area {
            align-items: center; /* จัดให้อยู่ตรงกลาง */
            width: 100%; /* ให้เต็มความกว้าง */
            margin-top: 0.75rem; /* เพิ่มช่องว่างด้านบนเล็กน้อย */
            padding-top: 0.75rem; /* เพิ่ม padding บนเส้นแบ่ง */
            border-top: 1px solid #f3f4f6; /* เส้นแบ่งบางๆ */
        }
        /* [FIX] ลบ display: flex !important; ที่ซ้ำซ้อนและอาจเกิดปัญหาออก */
        .datetime-group { 
            /* display: flex !important; */
        }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-8 p-6 bg-white shadow-xl rounded-xl">
      <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-2">
        Monitor Registration (Realtime)
      </h1>
      <p class="text-gray-500 mb-6">แสดงรายการผู้ที่ Check-In ล่าสุดและสรุปจำนวนรวม</p>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <button id="invited-btn" class="count-button bg-indigo-50 p-4 rounded-lg flex items-center shadow-md" onclick="filterRecords('Invited')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <div>
            <div class="text-sm font-medium text-indigo-600">Invited</div>
            <div id="invited-count" class="text-3xl font-bold text-indigo-800 animate-pulse">0</div>
          </div>
        </button>
        
        <button id="guest-btn" class="count-button bg-red-50 p-4 rounded-lg flex items-center shadow-md" onclick="filterRecords('Guest')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <div>
            <div class="text-sm font-medium text-red-600">Guest</div>
            <div id="guest-count" class="text-3xl font-bold text-red-800 animate-pulse">0</div>
          </div>
        </button>

        <button id="total-checked-in-btn" class="count-button bg-green-50 p-4 rounded-lg flex items-center shadow-md active green" onclick="filterRecords('All')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div>
            <div class="text-sm font-medium text-green-600">Total Checked-In</div>
            <div id="checked-in-count" class="text-3xl font-bold text-green-800 animate-pulse">0</div>
          </div>
        </button>
      </div>
      </header>

    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 id="results-header" class="text-xl font-semibold text-gray-700 mb-4">รายการ Total Checked-In ล่าสุด (0 รายการ)</h2>
      <div id="results-container" class="space-y-4">
        <p id="initial-message" class="text-center text-gray-500 p-8">กำลังโหลดข้อมูล...</p>
      </div>
      <p class="mt-4 text-center text-sm text-gray-500">อัปเดตอัตโนมัติทุก 30 วินาที</p>
    </div>
  </div>

  <div id="toast-message" class="fixed bottom-4 right-4 z-50 transition-transform transform translate-x-full duration-300 ease-out p-4 rounded-lg shadow-xl text-white font-medium max-w-sm">
    <div id="toast-content"></div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycbx1mUcX0lzIoCTLTF0P6FpWR7mz5b_e6Sda7aNHDXFBYBfqQUzay5ZD4H2o8gmnTkpe/exec";

// แก้ไข ID เพื่อให้ชัดเจนขึ้น
const INVITED_COUNT_EL = document.getElementById('invited-count'); 
const GUEST_COUNT_EL = document.getElementById('guest-count');
const CHECKED_IN_COUNT_EL = document.getElementById('checked-in-count');

const INVITED_BTN = document.getElementById('invited-btn');
const GUEST_BTN = document.getElementById('guest-btn');
const TOTAL_CHECKED_IN_BTN = document.getElementById('total-checked-in-btn');

const RESULTS_CONTAINER = document.getElementById('results-container');
const RESULTS_HEADER = document.getElementById('results-header');
const INITIAL_MESSAGE = document.getElementById('initial-message');

let allRecords = [];
// *** แก้ไข: เปลี่ยนสถานะเริ่มต้นจาก 'Invited' เป็น 'All' ***
let currentFilter = 'All'; 

/* ---------- Toast and Helpers ---------- */
function showToast(message, type='error') {
  const toastEl = document.getElementById('toast-message');
  const contentEl = document.getElementById('toast-content');
  toastEl.className = 'fixed bottom-4 right-4 z-50 transition-transform transform translate-x-full duration-300 ease-out p-4 rounded-lg shadow-xl text-white font-medium max-w-sm';
  toastEl.classList.add(type==='success'?'bg-green-600':type==='info'?'bg-blue-600':'bg-red-600');
  contentEl.textContent = message;
  requestAnimationFrame(()=>{ toastEl.classList.remove('translate-x-full'); toastEl.classList.add('translate-x-0'); });
  setTimeout(()=>{ toastEl.classList.remove('translate-x-0'); toastEl.classList.add('translate-x-full'); }, 3500);
}

const lcKeys = o => { const out={}; Object.keys(o||{}).forEach(k=>out[k.toLowerCase()]=o[k]); return out; };
const pickKey = (o,keys) => {const l=lcKeys(o); for(const k of keys) if(l.hasOwnProperty(k)) return k; return null;};
const toDateSafe = v => { if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; };

function toDateTimeParts(ts){
  const d = toDateSafe(ts);
  if(!d) return {date:'', time:''};
  // NEW: ใช้ toLocaleString เพื่อให้ได้รูปแบบวันที่และเวลาที่ต้องการ
  // 8/11/2568 (วันที่)
  const date = d.toLocaleDateString('th-TH', {day:'numeric',month:'numeric',year:'numeric'});
  // 22:01:00 (เวลาแบบ 24-hour)
  const time = d.toLocaleTimeString('th-TH', {hour:'2-digit',minute:'2-digit',second:'2-digit', hourCycle: 'h23'});
  return {date, time};
}

/* ---------- Normalize & Sort (เพิ่ม phone เพื่อให้รองรับเบอร์โทรตามภาพ) ---------- */
const KEY_CANDIDATES = {
  timestamp: ['check-in time','timestamp','check_in_time','checkintime','time','เวลาเช็คอิน','เช็คอิน','วันที่','เวลา'],
  order:     ['checkin_no','seq','order','index','ลำดับ','no','เลขที่'],
  status:    ['status','สถานะ','เช็คอินสถานะ','checkin_status'],
  name:      ['name','firstname','first_name','ชื่อ'],
  surname:   ['surname','lastname','last_name','นามสกุล'],
  position:  ['position','ตำแหน่ง'],
  company:   ['company','องค์กร','บริษัท','หน่วยงาน'],
  qr:        ['qr','qrcode','qr code','qr_url','qr-url','qrcodeurl','qrimage','qr_image','รูปqr','คิวอาร์'],
  // *** เพิ่มคีย์สำหรับเบอร์โทรศัพท์ (อ้างอิงจากคอลัมน์ G ใน Sheet) ***
  phone:     ['phone','mobile','tel','เบอร์โทร','เบอร์โทรศัพท์', 'g']
};

function normalizeRows(rawRows){
  // Assumption: rawRows is an array of objects where keys match header names from the Google Sheet
  return (rawRows||[]).map(r=>{
    const rk = lcKeys(r);
    const kTimestamp = pickKey(r, KEY_CANDIDATES.timestamp);
    const kOrder     = pickKey(r, KEY_CANDIDATES.order);
    const kStatus    = pickKey(r, KEY_CANDIDATES.status);
    const kName      = pickKey(r, KEY_CANDIDATES.name);
    const kSurname   = pickKey(r, KEY_CANDIDATES.surname);
    const kPosition  = pickKey(r, KEY_CANDIDATES.position);
    const kCompany   = pickKey(r, KEY_CANDIDATES.company);
    const kQR        = pickKey(r, KEY_CANDIDATES.qr);
    // *** ดึงคีย์สำหรับเบอร์โทรศัพท์ ***
    const kPhone     = pickKey(r, KEY_CANDIDATES.phone); 

    const statusRaw = kStatus ? rk[kStatus] : '';
    const statusStr = (statusRaw ?? '').toString().toLowerCase();
    const inferredChecked =
      (!!kOrder && rk[kOrder] !== undefined && rk[kOrder] !== '') ||
      (!!kTimestamp && !!rk[kTimestamp]) ||
      statusStr.includes('check in') ||
      statusStr.includes('เช็คอิน');

    return {
      name: (r.name ?? (kName ? rk[kName] : '') ?? '').toString(),
      surname: (r.surname ?? (kSurname ? rk[kSurname] : '') ?? '').toString(),
      position: (r.position ?? (kPosition ? rk[kPosition] : '') ?? '').toString(),
      company: (r.company ?? (kCompany ? rk[kCompany] : '') ?? '').toString(),
      qr: (r.qr ?? (kQR ? rk[kQR] : '') ?? '').toString(),
      status: (r.status ?? (kStatus ? rk[kStatus] : (inferredChecked ? 'Check In' : '')) ?? '').toString().trim(),
      timestamp: r['check-in time'] ?? (kTimestamp ? rk[kTimestamp] : '') ?? '',
      order: r.order ?? (kOrder ? rk[kOrder] : '') ?? '',
      // *** เพิ่มเบอร์โทรศัพท์ ***
      phone: r.phone ?? (kPhone ? rk[kPhone] : '') ?? ''
    };
  });
}

function sortByCheckin(records){
  const haveOrder = records.some(r => r.order !== '' && r.order != null);
  if (haveOrder){
    return [...records].sort((a,b)=>{
      const na = Number(String(a.order).replace(/[^\d.-]/g,'')); 
      const nb = Number(String(b.order).replace(/[^\d.-]/g,'')); 
      const aa = isNaN(na)?Infinity:na;
      const bb = isNaN(nb)?Infinity:nb;
      return aa - bb;
    });
  }
  return [...records].sort((a,b)=>{
    const ta = toDateSafe(a.timestamp)?.getTime() ?? -Infinity;
    const tb = toDateSafe(b.timestamp)?.getTime() ?? -Infinity;
    return tb - ta; // ใหม่ → เก่า
  });
}

/* ---------- PRINT LABEL (No Change) ---------- */
function buildLabelHTML(rec){
  const first   = (rec.name||'').toString().trim();
  const last    = (rec.surname||'').toString().trim();
  const company = (rec.company||'').toString().trim();
  const qrUrl   = (rec.qr||'').toString().trim();

  return `
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Label</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400&display=swap" rel="stylesheet">
  <style>
    @page { size: 70mm 50mm; margin: 0; }
    @media print { body { -webkit-print-color-adjust: exact; } }
    html,body{
      width:70mm; height:50mm; margin:0; padding:0;
      display:flex; align-items:center; justify-content:center;
      font-family:'Prompt',sans-serif; font-size:10pt; font-weight:400; color:#000;
    }
    .wrap{
      width:100%; height:100%;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; line-height:1.35;
    }
    .qr{ width:22mm; height:22mm; margin-bottom:4mm; display:flex; align-items:center; justify-content:center; }
    .qr img{ width:100%; height:100%; object-fit:contain; image-rendering:pixelated; }
    .name{ margin-bottom:1mm; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="qr">${qrUrl ? `<img id="qr-img" src="${qrUrl}" referrerpolicy="no-referrer" alt="QR Code">` : ``}</div>
    <div class="name">${first} ${last}</div>
    <div class="company">${company}</div>
  </div>
</body>
</html>`;
}

function printLabel(rec){
  const html = buildLabelHTML(rec);
  const old = document.getElementById('print-frame');
  if (old) old.remove();
  const iframe = document.createElement('iframe');
  iframe.id = 'print-frame';
  iframe.style.position = 'fixed';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.border = '0';
  iframe.style.visibility = 'hidden';
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();

  function waitImages(d){
    const imgs = Array.from(d.images || []);
    if (imgs.length === 0) return Promise.resolve();
    return Promise.all(imgs.map(img=>{
      if (img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise(res=>{
        img.addEventListener('load', res, {once:true});
        img.addEventListener('error', res, {once:true});
      });
    }));
  }
  const iw = iframe.contentWindow;
  const ready = Promise.all([
    new Promise(res => iw.addEventListener('load', res, {once:true})),
    (doc.fonts && doc.fonts.ready) ? doc.fonts.ready : Promise.resolve()
  ]).then(()=>waitImages(doc));
  ready.then(()=>{
    try{ iw.focus(); iw.print(); }catch(_){}
    setTimeout(()=>iframe.remove(), 1500);
  });
}

/* ---------- Render & Filter (ปรับปรุงการแสดงผล) ---------- */
function updateCounts(){
  
  // 1. นับจำนวน Invited (Status = 'Check In' เท่านั้น)
  const invitedCount = allRecords.filter(r => r.status === 'Check In').length;
  
  // 2. นับจำนวน Guest (Status = 'Guest' เท่านั้น)
  const guestCount = allRecords.filter(r => r.status === 'Guest').length;
  
  // 3. Total Checked-In: นับรวม Invited + Guest
  const totalCheckedIn = invitedCount + guestCount;

  INVITED_COUNT_EL.textContent = totalCheckedIn - guestCount; // แก้ไข: ให้แสดง Invited
  GUEST_COUNT_EL.textContent = guestCount;
  CHECKED_IN_COUNT_EL.textContent = totalCheckedIn;
  
  INVITED_COUNT_EL.classList.remove('animate-pulse');
  GUEST_COUNT_EL.classList.remove('animate-pulse');
  CHECKED_IN_COUNT_EL.classList.remove('animate-pulse');

  // หลังจากอัปเดตตัวเลข ให้ทำการกรองและแสดงผลตามสถานะปัจจุบัน
  filterRecords(currentFilter, false); 
}

function filterRecords(type, refreshButtons = true){
  currentFilter = type; 
  let filteredRecords = [];
  let headerText = 'รายการ Check-In ล่าสุด';

  if (type === 'Invited') {
    // กรองเฉพาะ Invited (Status = 'Check In')
    filteredRecords = allRecords.filter(r => r.status === 'Check In');
    headerText = `รายการ Invited ล่าสุด`;
  } else if (type === 'Guest') {
    // กรองเฉพาะ Guest (Status = 'Guest')
    filteredRecords = allRecords.filter(r => r.status === 'Guest');
    headerText = `รายการ Guest ล่าสุด`;
  } else if (type === 'All') {
    // กรองทั้งหมด (Status = 'Check In' หรือ 'Guest')
    filteredRecords = allRecords.filter(r => r.status === 'Check In' || r.status === 'Guest');
    headerText = `รายการ Total Checked-In ล่าสุด`;
  }

  // เรียงตามลำดับการบันทึกข้อมูล
  const sortedRecords = sortByCheckin(filteredRecords); 

  displayLiveFeed(sortedRecords, headerText);

  // อัปเดตสถานะปุ่ม (Active/Inactive)
  if(refreshButtons){
    INVITED_BTN.classList.remove('active');
    GUEST_BTN.classList.remove('active','red');
    TOTAL_CHECKED_IN_BTN.classList.remove('active','green');
    
    if(type === 'Invited') INVITED_BTN.classList.add('active');
    else if(type === 'Guest') GUEST_BTN.classList.add('active','red');
    else if(type === 'All') TOTAL_CHECKED_IN_BTN.classList.add('active','green');
  }
}


function displayLiveFeed(records, headerText){
  RESULTS_CONTAINER.innerHTML = '';
  INITIAL_MESSAGE.classList.add('hidden');

  RESULTS_HEADER.textContent = `${headerText} (${records.length} รายการ)`;

  if (!records.length){
    RESULTS_CONTAINER.innerHTML = '<p class="text-center text-gray-500 p-8">ไม่พบรายการ</p>';
    return;
  }
  records.forEach(r=>{
    const fullName = `${r.name||''} ${r.surname||''}`.trim() || 'N/A';
    const {date, time} = toDateTimeParts(r.timestamp);

    const isGuest = r.status === 'Guest';
    
    // กำหนดสไตล์ตามสถานะ
    let cardClass = 'bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0 ';
    let borderClass = 'border-indigo-200 hover:bg-indigo-50'; // โทนสีฟ้า/น้ำเงินสำหรับ Invited
    let statusBg = 'bg-indigo-100 text-indigo-700'; // สีป้ายสถานะ Invited

    if (isGuest) {
        borderClass = 'border-red-200 hover:bg-red-50'; // โทนสีแดง/ชมพูสำหรับ Guest
        statusBg = 'bg-red-100 text-red-700'; // สีป้ายสถานะ Guest
    }
    
    // ส่วนการสร้างลิงก์เบอร์โทร
    const cleanPhone = (r.phone||'').replace(/[^0-9+]/g, '');
    
    // โค้ด HTML สำหรับไอคอนสถานะ (Invited/Guest)
    const statusIcon = isGuest 
        ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
               <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7v1h14v-1a7 7 0 00-7-7z"/>
           </svg>
           Guest` 
        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
               <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
           </svg>
           Invited`;

    // NEW: โค้ดสำหรับไอคอน Date และ Time
    const calendarIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`;
    const clockIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;

    // [FIX] เพิ่มการเช็คเงื่อนไขและแสดงข้อความถ้าไม่มีเวลา Check-In
    const timestampHTML = (date && time) 
        ? `
        <div class="datetime-group">
            <span class="inline-flex items-center">${calendarIcon}${date}</span>
            <span class="separator">|</span>
            <span class="inline-flex items-center">${clockIcon}${time}</span>
        </div>`
        : `<div class="text-xs text-gray-400 font-medium w-full text-center md:text-right">ยังไม่มีเวลา Check-In</div>`;


    const card = document.createElement('div');
    card.className = `${cardClass} border ${borderClass}`;
    
    card.innerHTML = `
      <div class="flex-grow min-w-0">
        <p class="text-xl font-bold ${isGuest ? 'text-red-700' : 'text-indigo-700'} truncate">${fullName}</p>
        
        <p class="text-sm text-gray-500 font-medium mt-0">${r.position||'N/A'}</p>
        
        <p class="text-sm text-gray-700 inline-flex items-center space-x-1 mt-1">
            ${cleanPhone ? `
                <a href="tel:${cleanPhone}" class="phone-icon-anchor inline-flex items-center space-x-1">
                    <span class="phone-icon-circle">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1v3.5c0 .55-.45 1-1 1C10.74 21 3 13.26 3 5c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.24 1.02l-2.2 2.2z"/>
                        </svg>
                    </span>
                    <span class="text-gray-800">${r.phone}</span>
                </a>` : 
                `<span class="text-gray-500">-</span>`
            }
        </p>
        
        <p class="text-sm font-bold text-gray-800 mt-2">${r.company||'N/A'}</p>
      </div>
      
      <div class="right-content-area">
        <span class="inline-flex items-center px-3 py-1 text-sm rounded-full ${statusBg} font-semibold mb-1">
            ${statusIcon}
        </span>
        ${timestampHTML}
        <button class="mt-2 px-3 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700 print-button">
          Print Label 70×50 mm
        </button>
      </div>`;
    card.querySelector('button').addEventListener('click', ()=>printLabel(r));
    RESULTS_CONTAINER.appendChild(card);
  });
}

/* ---------- Loader: JSONP (No Change) ---------- */
async function tryFetchFallback(){
  try{
    const res = await fetch(`${GAS_URL}?t=${Date.now()}`, {mode:'cors',cache:'no-store'});
    const js = await res.json();
    const rows = Array.isArray(js?.data) ? js.data : (Array.isArray(js)?js:[]);
    allRecords = normalizeRows(rows);
    updateCounts(); 
  }catch(e){
    showToast('เชื่อมต่อไม่ได้: '+e.message,'error');
  }
}

function loadFromGAS_JSONP(){
  const cbName = 'onGASData_'+Date.now();
  let finished = false;
  let timedOut = false;
  const timeoutId = setTimeout(()=>{ timedOut=true; if(!finished) tryFetchFallback(); }, 4000);

  window[cbName] = (resp)=>{
    if (finished) return;
    finished = true;
    clearTimeout(timeoutId);
    try{
      const rows = Array.isArray(resp?.data) ? resp.data : (Array.isArray(resp)?resp:[]);
      allRecords = normalizeRows(rows);
      updateCounts(); 
    }finally{ try{ delete window[cbName]; }catch(_){} }
  };

  const s = document.createElement('script');
  s.src = `${GAS_URL}?callback=${cbName}&t=${Date.now()}`;
  s.async = true;
  s.onerror = ()=>{ if(!finished && !timedOut) setTimeout(()=>{ if(!finished) tryFetchFallback(); }, 100); };
  document.body.appendChild(s);
}

/* ---------- Auto refresh (No Change) ---------- */
function tick(){ loadFromGAS_JSONP(); setTimeout(tick, 30000); }
window.onload = ()=>{ INITIAL_MESSAGE.textContent='กำลังโหลดข้อมูล...'; tick(); };
</script>
</body>
</html>
