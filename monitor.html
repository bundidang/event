<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitor Registration (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Prompt', sans-serif !important; }
    body{ background:#f7f9fb }
    
    .count-button {
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      border: 2px solid transparent;
      outline: none;
    }
    .count-button:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    .count-button.active {
      border-color: rgba(79, 70, 229, 0.8);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    .count-button.active.red {
      border-color: rgba(220, 38, 38, 0.8);
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
    }
    .count-button.active.green {
      border-color: rgba(22, 163, 74, 0.8);
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.3);
    }
    .count-button.active.orange {
      border-color: rgba(249, 115, 22, 0.8);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3);
    }
    
    .phone-icon-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: black;
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.1); 
        flex-shrink: 0; 
    }
    .phone-icon-circle svg {
        fill: white; 
        width: 0.875rem;
        height: 0.875rem;
    }
    .phone-icon-anchor:hover .phone-icon-circle {
        background-color: #4f46e5; 
    }
    .phone-icon-anchor:hover span {
        color: #4f46e5; 
    }

    .print-button {
        display: block; 
    }
    @media (max-width: 767px) { 
        .print-button {
            display: none !important; 
        }
    }
    
    .datetime-group {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 0.75rem;
        width: 100%; 
    }
    .datetime-group > span {
        display: inline-flex;
        align-items: center;
        white-space: nowrap; 
    }
    .datetime-group .separator {
        margin: 0 0.25rem;
        color: #e5e7eb;
        font-weight: 300;
    }

    .right-content-area {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        flex-shrink: 0;
    }

    @media (max-width: 767px) {
        .right-content-area {
            align-items: center;
            width: 100%;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f3f4f6;
        }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-8">
        <div class="p-6 bg-white shadow-xl rounded-xl flex flex-col md:flex-row justify-between items-center gap-4">
          <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700">
            Monitor Registration (Realtime)
          </h1>
          <button onclick="exportToExcel()" class="inline-flex items-center px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Export to Excel
          </button>
        </div>
    </header>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <button id="total-checked-in-btn" class="count-button bg-green-50 p-4 rounded-lg flex flex-col items-center shadow-md active green" onclick="filterRecords('All Checked-in')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div class="text-center">
            <div class="text-sm font-medium text-green-600">Total Checked-in</div>
            <div id="checked-in-count" class="text-3xl font-bold text-green-800 animate-pulse">0</div>
          </div>
        </button>

        <button id="invited-btn" class="count-button bg-indigo-50 p-4 rounded-lg flex flex-col items-center shadow-md" onclick="filterRecords('Invited Check-in')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <div class="text-center">
            <div class="text-sm font-medium text-indigo-600">Invited Check-in</div>
            <div id="invited-count" class="text-3xl font-bold text-indigo-800 animate-pulse">0</div>
          </div>
        </button>
        
        <button id="guest-btn" class="count-button bg-red-50 p-4 rounded-lg flex flex-col items-center shadow-md" onclick="filterRecords('Walk-in, Guest')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <div class="text-center">
            <div class="text-sm font-medium text-red-600">Walk-in, Guest</div>
            <div id="guest-count" class="text-3xl font-bold text-red-800 animate-pulse">0</div>
          </div>
        </button>
      
        <button id="all-invited-btn" class="count-button bg-orange-50 p-4 rounded-lg flex flex-col items-center shadow-md" onclick="filterRecords('Attendee List (Waiting for Check-in)')">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9h2m-2 4h2m-6-4h.01M6 18h.01"/>
            </svg>
            <div class="text-center">
                <div class="text-sm font-medium text-orange-600">Attendee List (Waiting)</div>
                <div id="all-invited-count" class="text-3xl font-bold text-orange-800 animate-pulse">0</div>
            </div>
        </button>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 id="results-header" class="text-xl font-semibold text-gray-700 mb-4">รายการข้อมูล</h2> 
      <div id="results-container" class="space-y-4">
        <p id="initial-message" class="text-center text-gray-500 p-8">กำลังโหลดข้อมูล...</p>
      </div>
      <p class="mt-4 text-center text-sm text-gray-500">อัปเดตอัตโนมัติทุก 30 วินาที</p>
    </div>
  </div>

  <div id="toast-message" class="fixed bottom-4 right-4 z-50 transition-transform transform translate-x-full duration-300 ease-out p-4 rounded-lg shadow-xl text-white font-medium max-w-sm">
    <div id="toast-content"></div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwOXKcZBj1CZDLdemL4-XsxA9wCNql3FAtV1zvxW_WIOLOl5k4nLkNrqDfDPys5-hn0/exec"; 

const ALL_INVITED_COUNT_EL = document.getElementById('all-invited-count'); 
const INVITED_COUNT_EL = document.getElementById('invited-count'); 
const GUEST_COUNT_EL = document.getElementById('guest-count');
const CHECKED_IN_COUNT_EL = document.getElementById('checked-in-count');

const ALL_INVITED_BTN = document.getElementById('all-invited-btn'); 
const INVITED_BTN = document.getElementById('invited-btn');
const GUEST_BTN = document.getElementById('guest-btn');
const TOTAL_CHECKED_IN_BTN = document.getElementById('total-checked-in-btn');

const RESULTS_CONTAINER = document.getElementById('results-container');
const RESULTS_HEADER = document.getElementById('results-header');
const INITIAL_MESSAGE = document.getElementById('initial-message');

let allRecords = []; // ข้อมูลดิบที่ normalize แล้ว
let currentFilter = 'All Checked-in'; 

/* ---------- EXPORT FUNCTION (แก้ไขใหม่) ---------- */
function exportToExcel() {
    if (allRecords.length === 0) {
        showToast("ไม่มีข้อมูลสำหรับ Export", "error");
        return;
    }

    // เรียงลำดับจากเก่าไปใหม่ (Oldest to Newest) เหมือนใน Google Sheet
    // โดยใช้ Logic กลับกันกับที่แสดงผลบนหน้าจอ
    const exportSortedData = [...allRecords].sort((a, b) => {
        const orderA = Number(String(a.order).replace(/[^\d.-]/g,'')) || 0;
        const orderB = Number(String(b.order).replace(/[^\d.-]/g,'')) || 0;
        
        if (orderA !== 0 && orderB !== 0) {
            return orderA - orderB; // ลำดับน้อยไปหามาก
        }
        
        const timeA = toDateSafe(a.timestamp)?.getTime() || 0;
        const timeB = toDateSafe(b.timestamp)?.getTime() || 0;
        return timeA - timeB; // เวลาเก่าไปหาใหม่
    });

    // เตรียมข้อมูล Mapping หัวตาราง
    const exportData = exportSortedData.map((r, index) => {
        const {date, time} = toDateTimeParts(r.timestamp);
        return {
            "ลำดับ": r.order || index + 1,
            "ชื่อ": r.name || '',
            "นามสกุล": r.surname || '',
            "ตำแหน่ง": r.position || '-',
            "บริษัท/หน่วยงาน": r.company || '-',
            "เบอร์โทรศัพท์": r.phone || '-',
            "สถานะ": r.status === 'Check In' ? 'Invited' : (r.status === 'Guest' ? 'Walk-in' : 'Waiting'),
            "วันที่เช็คอิน": date || '-',
            "เวลาเช็คอิน": time || '-'
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(exportData);
    
    // ตั้งความกว้างคอลัมน์
    worksheet['!cols'] = [
        {wch: 8}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}
    ];

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "RegistrationData");

    const now = new Date();
    const fileName = `Registration_Report_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.xlsx`;

    XLSX.writeFile(workbook, fileName);
    showToast("Export ข้อมูลสำเร็จ (เรียงตามลำดับข้อมูลเก่า-ใหม่)", "success");
}

/* ---------- UI Helper Functions ---------- */
function showToast(message, type='error') {
  const toastEl = document.getElementById('toast-message');
  const contentEl = document.getElementById('toast-content');
  toastEl.className = 'fixed bottom-4 right-4 z-50 transition-transform transform translate-x-full duration-300 ease-out p-4 rounded-lg shadow-xl text-white font-medium max-w-sm';
  toastEl.classList.add(type==='success'?'bg-green-600':type==='info'?'bg-blue-600':'bg-red-600');
  contentEl.textContent = message;
  requestAnimationFrame(()=>{ toastEl.classList.remove('translate-x-full'); toastEl.classList.add('translate-x-0'); });
  setTimeout(()=>{ toastEl.classList.remove('translate-x-0'); toastEl.classList.add('translate-x-full'); }, 3500);
}

const lcKeys = o => { const out={}; Object.keys(o||{}).forEach(k=>out[k.toLowerCase()]=o[k]); return out; };
const pickKey = (o,keys) => {const l=lcKeys(o); for(const k of keys) if(l.hasOwnProperty(k)) return k; return null;};
const toDateSafe = v => { if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; };

function toDateTimeParts(ts){
  const d = toDateSafe(ts);
  if(!d) return {date:'', time:''};
  const date = d.toLocaleDateString('th-TH', {day:'numeric',month:'numeric',year:'numeric'});
  const time = d.toLocaleTimeString('th-TH', {hour:'2-digit',minute:'2-digit',second:'2-digit', hourCycle: 'h23'});
  return {date, time};
}

/* ---------- Data Processing ---------- */
const KEY_CANDIDATES = {
  timestamp: ['check-in time','timestamp','check_in_time','checkintime','time','เวลาเช็คอิน','เช็คอิน','วันที่','เวลา'],
  order:     ['checkin_no','seq','order','index','ลำดับ','no','เลขที่'],
  status:    ['status','สถานะ','เช็คอินสถานะ','checkin_status'],
  name:      ['name','firstname','first_name','ชื่อ','c'], 
  surname:   ['surname','lastname','last_name','นามสกุล','d'],
  position:  ['position','ตำแหน่ง','e'],
  company:   ['company','องค์กร','บริษัท','หน่วยงาน','f'],
  qr:        ['qr','qrcode','qr code','qr_url','qr-url','qrcodeurl','qrimage','qr_image','รูปqr','คิวอาร์','h'],
  phone:     ['phone','mobile','tel','เบอร์โทร','เบอร์โทรศัพท์', 'g']
};

function normalizeRows(rawRows){
  return (rawRows||[]).map(r=>{
    const rk = lcKeys(r);
    const kTimestamp = pickKey(r, KEY_CANDIDATES.timestamp);
    const kOrder     = pickKey(r, KEY_CANDIDATES.order);
    const kStatus    = pickKey(r, KEY_CANDIDATES.status);
    const kName      = pickKey(r, KEY_CANDIDATES.name);
    const kSurname   = pickKey(r, KEY_CANDIDATES.surname);
    const kPosition  = pickKey(r, KEY_CANDIDATES.position);
    const kCompany   = pickKey(r, KEY_CANDIDATES.company);
    const kQR        = pickKey(r, KEY_CANDIDATES.qr);
    const kPhone     = pickKey(r, KEY_CANDIDATES.phone); 

    const statusRaw = kStatus ? rk[kStatus] : '';
    const statusStr = (statusRaw ?? '').toString().toLowerCase();
    const inferredChecked = (!!kOrder && rk[kOrder] !== undefined && rk[kOrder] !== '') || (!!kTimestamp && !!rk[kTimestamp]) || statusStr.includes('check in') || statusStr.includes('เช็คอิน');

    return {
      name: (r.name ?? (kName ? rk[kName] : '') ?? '').toString(),
      surname: (r.surname ?? (kSurname ? rk[kSurname] : '') ?? '').toString(),
      position: (r.position ?? (kPosition ? rk[kPosition] : '') ?? '').toString(),
      company: (r.company ?? (kCompany ? rk[kCompany] : '') ?? '').toString(),
      qr: (r.qr ?? (kQR ? rk[kQR] : '') ?? '').toString(),
      status: (r.status ?? (kStatus ? rk[kStatus] : (inferredChecked ? 'Check In' : '')) ?? '').toString().trim(),
      timestamp: r['check-in time'] ?? (kTimestamp ? rk[kTimestamp] : '') ?? '',
      order: r.order ?? (kOrder ? rk[kOrder] : '') ?? '',
      phone: r.phone ?? (kPhone ? rk[kPhone] : '') ?? ''
    };
  });
}

// ฟังก์ชันสำหรับหน้าจอ: เรียง "ใหม่ไปเก่า"
function sortByCheckinForDisplay(records){
  return [...records].sort((a,b)=>{
    const na = Number(String(a.order).replace(/[^\d.-]/g,'')) || 0;
    const nb = Number(String(b.order).replace(/[^\d.-]/g,'')) || 0;
    if(na !== 0 && nb !== 0) return nb - na; 
    const ta = toDateSafe(a.timestamp)?.getTime() ?? 0;
    const tb = toDateSafe(b.timestamp)?.getTime() ?? 0;
    return tb - ta;
  });
}

/* ---------- Print Function ---------- */
function printLabel(rec){
  const first = (rec.name||'').toString().trim();
  const last = (rec.surname||'').toString().trim();
  const company = (rec.company||'').toString().trim();
  const qrUrl = (rec.qr||'').toString().trim();
  
  const html = `<!DOCTYPE html><html lang="th"><head><meta charset="utf-8"><title>Label</title><link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400&display=swap" rel="stylesheet"><style>@page { size: 70mm 50mm; margin: 0; } @media print { body { -webkit-print-color-adjust: exact; } } html,body{ width:70mm; height:50mm; margin:0; padding:0; display:flex; align-items:center; justify-content:center; font-family:'Prompt',sans-serif; font-size:10pt; font-weight:400; color:#000; } .wrap{ width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; line-height:1.35; } .qr{ width:22mm; height:22mm; margin-bottom:4mm; display:flex; align-items:center; justify-content:center; } .qr img{ width:100%; height:100%; object-fit:contain; } .name{ margin-bottom:1mm; }</style></head><body><div class="wrap"><div class="qr">${qrUrl ? `<img src="${qrUrl}" referrerpolicy="no-referrer">` : ``}</div><div class="name">${first} ${last}</div><div class="company">${company}</div></div></body></html>`;

  const old = document.getElementById('print-frame');
  if (old) old.remove();
  const iframe = document.createElement('iframe');
  iframe.id = 'print-frame'; iframe.style.position = 'fixed'; iframe.style.width = '0'; iframe.style.height = '0'; iframe.style.border = '0'; iframe.style.visibility = 'hidden';
  document.body.appendChild(iframe);
  const doc = iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();
  const iw = iframe.contentWindow;
  const ready = Promise.all([new Promise(res => iw.addEventListener('load', res, {once:true})), (doc.fonts && doc.fonts.ready) ? doc.fonts.ready : Promise.resolve()]);
  ready.then(()=>{
    try{ iw.focus(); iw.print(); }catch(_){}
    setTimeout(()=>iframe.remove(), 1500);
  });
}

/* ---------- Logic & Feed ---------- */
function updateCounts(){
    const allInvitedCount = allRecords.filter(r => (r.name || r.surname || r.position || r.company || r.phone || r.qr) && r.status !== 'Check In' && r.status !== 'Guest').length;
    const invitedCheckInCount = allRecords.filter(r => r.status === 'Check In').length;
    const guestCount = allRecords.filter(r => r.status === 'Guest').length;
    const totalCheckedIn = invitedCheckInCount + guestCount;

    ALL_INVITED_COUNT_EL.textContent = allInvitedCount; 
    INVITED_COUNT_EL.textContent = invitedCheckInCount;
    GUEST_COUNT_EL.textContent = guestCount;
    CHECKED_IN_COUNT_EL.textContent = totalCheckedIn;
    
    [ALL_INVITED_COUNT_EL, INVITED_COUNT_EL, GUEST_COUNT_EL, CHECKED_IN_COUNT_EL].forEach(el => el.classList.remove('animate-pulse'));
    filterRecords(currentFilter, false); 
}

function filterRecords(type, refreshButtons = true){
    currentFilter = type; 
    let filteredRecords = [];
    let headerText = 'รายการล่าสุด';

    if (type === 'All Checked-in') {
        filteredRecords = allRecords.filter(r => r.status === 'Check In' || r.status === 'Guest');
        headerText = `รายการ Total Checked-in ล่าสุด`;
    } else if (type === 'Invited Check-in') {
        filteredRecords = allRecords.filter(r => r.status === 'Check In');
        headerText = `รายการ Invited Check-in ล่าสุด`;
    } else if (type === 'Walk-in, Guest') {
        filteredRecords = allRecords.filter(r => r.status === 'Guest');
        headerText = `รายการ Walk-in, Guest ล่าสุด`;
    } else if (type === 'Attendee List (Waiting for Check-in)') {
        filteredRecords = allRecords.filter(r => (r.name || r.surname || r.position || r.company || r.phone || r.qr) && r.status !== 'Check In' && r.status !== 'Guest');
        headerText = `รายการ Attendee List (Waiting) ล่าสุด`;
    }

    displayLiveFeed(sortByCheckinForDisplay(filteredRecords), headerText);

    if(refreshButtons){
        [ALL_INVITED_BTN, INVITED_BTN, GUEST_BTN, TOTAL_CHECKED_IN_BTN].forEach(btn => btn.classList.remove('active', 'orange', 'red', 'green'));
        if(type === 'Attendee List (Waiting for Check-in)') ALL_INVITED_BTN.classList.add('active', 'orange');
        else if(type === 'Invited Check-in') INVITED_BTN.classList.add('active');
        else if(type === 'Walk-in, Guest') GUEST_BTN.classList.add('active','red');
        else if(type === 'All Checked-in') TOTAL_CHECKED_IN_BTN.classList.add('active','green');
    }
}

function displayLiveFeed(records, headerText){
  RESULTS_CONTAINER.innerHTML = '';
  INITIAL_MESSAGE.classList.add('hidden');
  RESULTS_HEADER.textContent = `${headerText} (${records.length} รายการ)`;
  if (!records.length){
    RESULTS_CONTAINER.innerHTML = '<p class="text-center text-gray-500 p-8">ไม่พบรายการ</p>';
    return;
  }
  records.forEach(r=>{
    const fullName = `${r.name||''} ${r.surname||''}`.trim() || 'N/A';
    const {date, time} = toDateTimeParts(r.timestamp);
    const isGuest = r.status === 'Guest';
    const isCheckedIn = r.status === 'Check In' || r.status === 'Guest';
    const isWaitingCheckIn = (r.name || r.surname || r.position || r.company || r.phone || r.qr) && r.status !== 'Check In' && r.status !== 'Guest';

    let cardClass = 'bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0 ';
    let borderClass = 'border-gray-200 hover:bg-gray-50';
    let statusBg = 'bg-gray-100 text-gray-700';
    let statusIcon = `Invited`;

    if (isWaitingCheckIn) {
        borderClass = 'border-orange-200 hover:bg-orange-50';
        statusBg = 'bg-orange-100 text-orange-700'; 
        statusIcon = `Waiting`;
    } else if (r.status === 'Check In') {
        borderClass = 'border-indigo-200 hover:bg-indigo-50';
        statusBg = 'bg-indigo-100 text-indigo-700';
        statusIcon = `Invited Check-in`;
    } else if (isGuest) {
        borderClass = 'border-red-200 hover:bg-red-50';
        statusBg = 'bg-red-100 text-red-700'; 
        statusIcon = `Walk-in, Guest`;
    }
    
    let nameTextColor = isWaitingCheckIn ? 'text-orange-700' : isGuest ? 'text-red-700' : 'text-indigo-700';
    if (currentFilter === 'All Checked-in' && isCheckedIn) nameTextColor = 'text-green-700';

    const cleanPhone = (r.phone||'').replace(/[^0-9+]/g, '');
    const timestampHTML = (date && time && isCheckedIn) ? `<div class="datetime-group"><span class="inline-flex items-center">${date}</span><span class="separator">|</span><span class="inline-flex items-center">${time}</span></div>` : `<div class="text-xs text-gray-400 font-medium w-full text-center md:text-right">${isCheckedIn ? 'ไม่พบเวลา' : 'ยังไม่เช็คอิน'}</div>`;

    const card = document.createElement('div');
    card.className = `${cardClass} border ${borderClass}`;
    card.innerHTML = `
      <div class="flex-grow min-w-0">
        <p class="text-xl font-bold ${nameTextColor} truncate">${fullName}</p>
        <p class="text-sm text-gray-500 font-medium mt-0">${r.position||'N/A'}</p>
        <p class="text-sm text-gray-700 inline-flex items-center space-x-1 mt-1">
            ${cleanPhone ? `<a href="tel:${cleanPhone}" class="phone-icon-anchor inline-flex items-center space-x-1"><span class="phone-icon-circle"><svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1v3.5c0 .55-.45 1-1 1C10.74 21 3 13.26 3 5c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.24 1.02l-2.2 2.2z"/></svg></span><span class="text-gray-800">${r.phone}</span></a>` : `<span class="text-gray-500">-</span>`}
        </p>
        <p class="text-sm font-bold text-gray-800 mt-2">${r.company||'N/A'}</p>
      </div>
      <div class="right-content-area">
        <span class="inline-flex items-center px-3 py-1 text-sm rounded-full ${statusBg} font-semibold mb-1">${statusIcon}</span>
        ${timestampHTML}
        ${isCheckedIn ? `<button class="mt-2 px-3 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700 print-button">Print Label</button>` : ''}
      </div>`;
    const pb = card.querySelector('.print-button');
    if (pb) pb.onclick = () => printLabel(r);
    RESULTS_CONTAINER.appendChild(card);
  });
}

async function tryFetchFallback(){
  try{
    const res = await fetch(`${GAS_URL}?t=${Date.now()}`, {mode:'cors',cache:'no-store'});
    const js = await res.json();
    const rows = Array.isArray(js?.data) ? js.data : (Array.isArray(js)?js:[]);
    allRecords = normalizeRows(rows);
    updateCounts(); 
  }catch(e){ showToast('เชื่อมต่อไม่ได้: '+e.message,'error'); }
}

function loadFromGAS_JSONP(){
  const cbName = 'onGASData_'+Date.now();
  let finished = false;
  const timeoutId = setTimeout(()=>{ if(!finished) tryFetchFallback(); }, 4000);
  window[cbName] = (resp)=>{
    finished = true; clearTimeout(timeoutId);
    const rows = Array.isArray(resp?.data) ? resp.data : (Array.isArray(resp)?resp:[]);
    allRecords = normalizeRows(rows);
    updateCounts();
    try{ delete window[cbName]; }catch(_){}
  };
  const s = document.createElement('script');
  s.src = `${GAS_URL}?callback=${cbName}&t=${Date.now()}`;
  s.async = true;
  document.body.appendChild(s);
}

function tick(){ loadFromGAS_JSONP(); setTimeout(tick, 30000); }
window.onload = ()=>{ INITIAL_MESSAGE.textContent='กำลังโหลดข้อมูล...'; tick(); };
</script>
</body>
</html>
