<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitor Registration (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Prompt', sans-serif !important; }
    body{ background:#f7f9fb }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö */
    .count-button {
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      border: 2px solid transparent;
      outline: none;
    }
    .count-button:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    .count-button.active {
      border-color: rgba(79, 70, 229, 0.8); /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active (Invited) */
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
    }
    .count-button.active.red {
      border-color: rgba(220, 38, 38, 0.8); /* Guest */
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
    }
    .count-button.active.green {
      border-color: rgba(22, 163, 74, 0.8); /* Total Checked-In */
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.3);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-8 p-6 bg-white shadow-xl rounded-xl">
      <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-2">
        Monitor Registration (Realtime)
      </h1>
      <p class="text-gray-500 mb-6">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà Check-In ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</p>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <button id="invited-btn" class="count-button bg-indigo-50 p-4 rounded-lg flex items-center shadow-md" onclick="filterRecords('Invited')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <div>
            <div class="text-sm font-medium text-indigo-600">Invited</div>
            <div id="invited-count" class="text-3xl font-bold text-indigo-800 animate-pulse">0</div>
          </div>
        </button>
        
        <button id="guest-btn" class="count-button bg-red-50 p-4 rounded-lg flex items-center shadow-md" onclick="filterRecords('Guest')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <div>
            <div class="text-sm font-medium text-red-600">Guest</div>
            <div id="guest-count" class="text-3xl font-bold text-red-800 animate-pulse">0</div>
          </div>
        </button>

        <button id="total-checked-in-btn" class="count-button bg-green-50 p-4 rounded-lg flex items-center shadow-md active green" onclick="filterRecords('All')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div>
            <div class="text-sm font-medium text-green-600">Total Checked-In</div>
            <div id="checked-in-count" class="text-3xl font-bold text-green-800 animate-pulse">0</div>
          </div>
        </button>
      </div>
      </header>

    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 id="results-header" class="text-xl font-semibold text-gray-700 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Total Checked-In ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h2>
      <div id="results-container" class="space-y-4">
        <p id="initial-message" class="text-center text-gray-500 p-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
      </div>
      <p class="mt-4 text-center text-sm text-gray-500">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
    </div>
  </div>

  <div id="toast-message" class="fixed bottom-4 right-4 z-50 transition-transform transform translate-x-full duration-300 ease-out p-4 rounded-lg shadow-xl text-white font-medium max-w-sm">
    <div id="toast-content"></div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycby_63E2g_MjI1ZljtI6XGryWmxcsrxFUTDtAEWS7mIo7VgDgZ2rhbOtVNWzIPhI46ky/exec";

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
const INVITED_COUNT_EL = document.getElementById('invited-count'); 
const GUEST_COUNT_EL = document.getElementById('guest-count');
const CHECKED_IN_COUNT_EL = document.getElementById('checked-in-count');

const INVITED_BTN = document.getElementById('invited-btn');
const GUEST_BTN = document.getElementById('guest-btn');
const TOTAL_CHECKED_IN_BTN = document.getElementById('total-checked-in-btn');

const RESULTS_CONTAINER = document.getElementById('results-container');
const RESULTS_HEADER = document.getElementById('results-header');
const INITIAL_MESSAGE = document.getElementById('initial-message');

let allRecords = [];
// *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å 'Invited' ‡πÄ‡∏õ‡πá‡∏ô 'All' ***
let currentFilter = 'All'; 

/* ---------- Toast and Helpers (No Change) ---------- */
function showToast(message, type='error') {
  const toastEl = document.getElementById('toast-message');
  const contentEl = document.getElementById('toast-content');
  toastEl.className = 'fixed bottom-4 right-4 z-50 transition-transform transform translate-x-full duration-300 ease-out p-4 rounded-lg shadow-xl text-white font-medium max-w-sm';
  toastEl.classList.add(type==='success'?'bg-green-600':type==='info'?'bg-blue-600':'bg-red-600');
  contentEl.textContent = message;
  requestAnimationFrame(()=>{ toastEl.classList.remove('translate-x-full'); toastEl.classList.add('translate-x-0'); });
  setTimeout(()=>{ toastEl.classList.remove('translate-x-0'); toastEl.classList.add('translate-x-full'); }, 3500);
}

const lcKeys = o => { const out={}; Object.keys(o||{}).forEach(k=>out[k.toLowerCase()]=o[k]); return out; };
const pickKey = (o,keys) => {const l=lcKeys(o); for(const k of keys) if(l.hasOwnProperty(k)) return k; return null;};
const toDateSafe = v => { if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; };

function toDateTimeParts(ts){
  const d = toDateSafe(ts);
  if(!d) return {date:'', time:''};
  const date = d.toLocaleDateString('th-TH',{day:'numeric',month:'numeric',year:'numeric'});
  const time = d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  return {date, time};
}

/* ---------- Normalize & Sort (No Change) ---------- */
const KEY_CANDIDATES = {
  timestamp: ['check-in time','timestamp','check_in_time','checkintime','time','‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô','‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡πÄ‡∏ß‡∏•‡∏≤'],
  order:     ['checkin_no','seq','order','index','‡∏•‡∏≥‡∏î‡∏±‡∏ö','no','‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'],
  status:    ['status','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','checkin_status'],
  name:      ['name','firstname','first_name','‡∏ä‡∏∑‡πà‡∏≠'],
  surname:   ['surname','lastname','last_name','‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'],
  position:  ['position','‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'],
  company:   ['company','‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'],
  qr:        ['qr','qrcode','qr code','qr_url','qr-url','qrcodeurl','qrimage','qr_image','‡∏£‡∏π‡∏õqr','‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå']
};

function normalizeRows(rawRows){
  return (rawRows||[]).map(r=>{
    const rk = lcKeys(r);
    const kTimestamp = pickKey(r, KEY_CANDIDATES.timestamp);
    const kOrder     = pickKey(r, KEY_CANDIDATES.order);
    const kStatus    = pickKey(r, KEY_CANDIDATES.status);
    const kName      = pickKey(r, KEY_CANDIDATES.name);
    const kSurname   = pickKey(r, KEY_CANDIDATES.surname);
    const kPosition  = pickKey(r, KEY_CANDIDATES.position);
    const kCompany   = pickKey(r, KEY_CANDIDATES.company);
    const kQR        = pickKey(r, KEY_CANDIDATES.qr);

    const statusRaw = kStatus ? rk[kStatus] : '';
    const statusStr = (statusRaw ?? '').toString().toLowerCase();
    const inferredChecked =
      (!!kOrder && rk[kOrder] !== undefined && rk[kOrder] !== '') ||
      (!!kTimestamp && !!rk[kTimestamp]) ||
      statusStr.includes('check in') ||
      statusStr.includes('‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô');

    return {
      name: (r.name ?? (kName ? rk[kName] : '') ?? '').toString(),
      surname: (r.surname ?? (kSurname ? rk[kSurname] : '') ?? '').toString(),
      position: (r.position ?? (kPosition ? rk[kPosition] : '') ?? '').toString(),
      company: (r.company ?? (kCompany ? rk[kCompany] : '') ?? '').toString(),
      qr: (r.qr ?? (kQR ? rk[kQR] : '') ?? '').toString(),
      status: (r.status ?? (kStatus ? rk[kStatus] : (inferredChecked ? 'Check In' : '')) ?? '').toString().trim(),
      timestamp: r['check-in time'] ?? (kTimestamp ? rk[kTimestamp] : '') ?? '',
      order: r.order ?? (kOrder ? rk[kOrder] : '') ?? ''
    };
  });
}

function sortByCheckin(records){
  const haveOrder = records.some(r => r.order !== '' && r.order != null);
  if (haveOrder){
    return [...records].sort((a,b)=>{
      const na = Number(String(a.order).replace(/[^\d.-]/g,'')); 
      const nb = Number(String(b.order).replace(/[^\d.-]/g,'')); 
      const aa = isNaN(na)?Infinity:na;
      const bb = isNaN(nb)?Infinity:nb;
      return aa - bb;
    });
  }
  return [...records].sort((a,b)=>{
    const ta = toDateSafe(a.timestamp)?.getTime() ?? -Infinity;
    const tb = toDateSafe(b.timestamp)?.getTime() ?? -Infinity;
    return tb - ta; // ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏Å‡πà‡∏≤
  });
}

/* ---------- PRINT LABEL (No Change) ---------- */
function buildLabelHTML(rec){
  const first   = (rec.name||'').toString().trim();
  const last    = (rec.surname||'').toString().trim();
  const company = (rec.company||'').toString().trim();
  const qrUrl   = (rec.qr||'').toString().trim();

  return `
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Label</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400&display=swap" rel="stylesheet">
  <style>
    @page { size: 70mm 50mm; margin: 0; }
    @media print { body { -webkit-print-color-adjust: exact; } }
    html,body{
      width:70mm; height:50mm; margin:0; padding:0;
      display:flex; align-items:center; justify-content:center;
      font-family:'Prompt',sans-serif; font-size:10pt; font-weight:400; color:#000;
    }
    .wrap{
      width:100%; height:100%;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; line-height:1.35;
    }
    .qr{ width:22mm; height:22mm; margin-bottom:4mm; display:flex; align-items:center; justify-content:center; }
    .qr img{ width:100%; height:100%; object-fit:contain; image-rendering:pixelated; }
    .name{ margin-bottom:1mm; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="qr">${qrUrl ? `<img id="qr-img" src="${qrUrl}" referrerpolicy="no-referrer" alt="QR Code">` : ``}</div>
    <div class="name">${first} ${last}</div>
    <div class="company">${company}</div>
  </div>
</body>
</html>`;
}

function printLabel(rec){
  const html = buildLabelHTML(rec);
  const old = document.getElementById('print-frame');
  if (old) old.remove();
  const iframe = document.createElement('iframe');
  iframe.id = 'print-frame';
  iframe.style.position = 'fixed';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.border = '0';
  iframe.style.visibility = 'hidden';
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();

  function waitImages(d){
    const imgs = Array.from(d.images || []);
    if (imgs.length === 0) return Promise.resolve();
    return Promise.all(imgs.map(img=>{
      if (img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise(res=>{
        img.addEventListener('load', res, {once:true});
        img.addEventListener('error', res, {once:true});
      });
    }));
  }
  const iw = iframe.contentWindow;
  const ready = Promise.all([
    new Promise(res => iw.addEventListener('load', res, {once:true})),
    (doc.fonts && doc.fonts.ready) ? doc.fonts.ready : Promise.resolve()
  ]).then(()=>waitImages(doc));
  ready.then(()=>{
    try{ iw.focus(); iw.print(); }catch(_){}
    setTimeout(()=>iframe.remove(), 1500);
  });
}

/* ---------- Render & Filter ---------- */
function updateCounts(){
  
  // 1. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Invited (Status = 'Check In' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  const invitedCount = allRecords.filter(r => r.status === 'Check In').length;
  
  // 2. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Guest (Status = 'Guest' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  const guestCount = allRecords.filter(r => r.status === 'Guest').length;
  
  // 3. Total Checked-In: ‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏° Invited + Guest
  const totalCheckedIn = invitedCount + guestCount;

  INVITED_COUNT_EL.textContent = invitedCount; 
  GUEST_COUNT_EL.textContent = guestCount;
  CHECKED_IN_COUNT_EL.textContent = totalCheckedIn;
  
  INVITED_COUNT_EL.classList.remove('animate-pulse');
  GUEST_COUNT_EL.classList.remove('animate-pulse');
  CHECKED_IN_COUNT_EL.classList.remove('animate-pulse');

  // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ filterRecords(currentFilter) ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤ currentFilter ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'All' ‡πÅ‡∏•‡πâ‡∏ß ***
  filterRecords(currentFilter, false); 
}

function filterRecords(type, refreshButtons = true){
  currentFilter = type; 
  let filteredRecords = [];
  let headerText = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Check-In ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';

  if (type === 'Invited') {
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Invited (Status = 'Check In')
    filteredRecords = allRecords.filter(r => r.status === 'Check In');
    headerText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Invited ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`;
  } else if (type === 'Guest') {
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Guest (Status = 'Guest')
    filteredRecords = allRecords.filter(r => r.status === 'Guest');
    headerText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Guest ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`;
  } else if (type === 'All') {
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Status = 'Check In' ‡∏´‡∏£‡∏∑‡∏≠ 'Guest')
    filteredRecords = allRecords.filter(r => r.status === 'Check In' || r.status === 'Guest');
    headerText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Total Checked-In ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const sortedRecords = sortByCheckin(filteredRecords); 

  displayLiveFeed(sortedRecords, headerText);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° (Active/Inactive)
  if(refreshButtons){
    INVITED_BTN.classList.remove('active');
    GUEST_BTN.classList.remove('active','red');
    TOTAL_CHECKED_IN_BTN.classList.remove('active','green');
    
    if(type === 'Invited') INVITED_BTN.classList.add('active');
    else if(type === 'Guest') GUEST_BTN.classList.add('active','red');
    else if(type === 'All') TOTAL_CHECKED_IN_BTN.classList.add('active','green');
  }
}


function displayLiveFeed(records, headerText){
  RESULTS_CONTAINER.innerHTML = '';
  INITIAL_MESSAGE.classList.add('hidden');

  RESULTS_HEADER.textContent = `${headerText} (${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

  if (!records.length){
    RESULTS_CONTAINER.innerHTML = '<p class="text-center text-gray-500 p-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
    return;
  }
  records.forEach(r=>{
    const fullName = `${r.name||''} ${r.surname||''}`.trim() || 'N/A';
    const {date, time} = toDateTimeParts(r.timestamp);

    const isGuest = r.status === 'Guest';
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let cardClass = 'bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0 ';
    let borderClass = 'border-indigo-200 hover:bg-indigo-50'; // ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Invited
    let statusBg = 'bg-indigo-100 text-indigo-700'; // ‡∏™‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Invited

    if (isGuest) {
        borderClass = 'border-red-200 hover:bg-red-50'; // ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á/‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Guest
        statusBg = 'bg-red-100 text-red-700'; // ‡∏™‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Guest
    }
    
    const card = document.createElement('div');
    card.className = `${cardClass} border ${borderClass}`;
    
    card.innerHTML = `
      <div class="flex-grow min-w-0">
        <p class="text-xl font-bold text-gray-800 truncate">${fullName}</p>
        <p class="text-sm ${isGuest ? 'text-red-600' : 'text-indigo-600'} font-medium">${r.position||'N/A'}</p>
        <p class="text-sm text-gray-500">${r.company||'N/A'}</p>
      </div>
      <div class="flex flex-col items-end md:items-center flex-shrink-0">
        <span class="inline-flex items-center px-3 py-1 text-sm rounded-full ${statusBg} font-semibold mb-1">
            ${isGuest ? 'üë§ Guest' : '‚úÖ Invited'}
        </span>
        <p class="text-xs text-gray-400">Date: ${date}</p>
        <p class="text-xs text-gray-400">Time: ${time}</p>
        <button class="mt-2 px-3 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700">
          Print Label 70√ó50 mm
        </button>
      </div>`;
    card.querySelector('button').addEventListener('click', ()=>printLabel(r));
    RESULTS_CONTAINER.appendChild(card);
  });
}

/* ---------- Loader: JSONP (No Change) ---------- */
async function tryFetchFallback(){
  try{
    const res = await fetch(`${GAS_URL}?t=${Date.now()}`, {mode:'cors',cache:'no-store'});
    const js = await res.json();
    const rows = Array.isArray(js?.data) ? js.data : (Array.isArray(js)?js:[]);
    allRecords = normalizeRows(rows);
    updateCounts(); 
  }catch(e){
    showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message,'error');
  }
}

function loadFromGAS_JSONP(){
  const cbName = 'onGASData_'+Date.now();
  let finished = false;
  let timedOut = false;
  const timeoutId = setTimeout(()=>{ timedOut=true; if(!finished) tryFetchFallback(); }, 4000);

  window[cbName] = (resp)=>{
    if (finished) return;
    finished = true;
    clearTimeout(timeoutId);
    try{
      const rows = Array.isArray(resp?.data) ? resp.data : (Array.isArray(resp)?resp:[]);
      allRecords = normalizeRows(rows);
      updateCounts(); 
    }finally{ try{ delete window[cbName]; }catch(_){} }
  };

  const s = document.createElement('script');
  s.src = `${GAS_URL}?callback=${cbName}&t=${Date.now()}`;
  s.async = true;
  s.onerror = ()=>{ if(!finished && !timedOut) setTimeout(()=>{ if(!finished) tryFetchFallback(); }, 100); };
  document.body.appendChild(s);
}

/* ---------- Auto refresh (No Change) ---------- */
function tick(){ loadFromGAS_JSONP(); setTimeout(tick, 30000); }
window.onload = ()=>{ INITIAL_MESSAGE.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; tick(); };
</script>
</body>
</html>
