<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search & Check-In</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Prompt','Tahoma','Arial',sans-serif;background:#f0f2f5;display:flex;flex-direction:column;align-items:center;padding:20px;color:#333}
    .container{width:100%;max-width:800px;margin:0 auto}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#1a1a1a;font-size:28px;margin-bottom:5px}
    .search-box{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:40px;text-align:center}
    .search-inputs{display:flex;flex-direction:column;gap:10px;margin-bottom:15px;align-items:center}
    .input-group{display:flex;align-items:center;background:#fff;padding:10px 15px;border-radius:8px;border:1px solid #e0e0e0;width:100%;max-width:450px}
    .input-group label{color:#ff7f00;font-weight:bold;margin-right:10px}
    .input-group input{border:none;outline:none;flex-grow:1;font-size:16px;padding:5px 0;background:transparent;color:#333}
    .action-buttons{display:flex;gap:10px;justify-content:center;width:100%;max-width:450px}
    .btn-search,.btn-scan{color:#fff;padding:15px 25px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:background-color .3s;flex-grow:1}
    .btn-search{background:#ff7f00}.btn-search:hover{background:#cc6600}
    .btn-scan{background:#4CAF50}.btn-scan:hover{background:#45a049}
    .search-info{color:#999;font-size:14px;margin-top:10px}
    #results-container{max-height:400px;overflow-y:auto;padding:10px;border:1px solid #cccccc40;border-radius:8px;margin-top:20px;display:none}
    .result-box{background:#fff;padding:20px 30px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);text-align:left;margin-bottom:15px}
    .result-title{display:flex;align-items:center;font-size:20px;font-weight:bold;color:#1a1a1a;border-bottom:2px solid #e0e0e0;padding-bottom:10px;margin-bottom:20px}
    .result-title span{background:#ff7f00;color:#fff;border-radius:50%;width:25px;height:25px;display:flex;justify-content:center;align-items:center;font-size:16px;margin-right:10px}
    .data-row{display:flex;padding:8px 0;border-bottom:1px dashed #e9ecef;font-size:15px}
    .data-label{width:180px;color:#555}
    .data-value{font-weight:bold;color:#333;flex-grow:1}
    .status-checked-in{color:#4CAF50;font-weight:bold;}
    .status-pending{color:#ff7f00;font-weight:bold;}
    #status-message{margin-top:20px;font-size:15px;font-weight:600;color:#6b7280}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #ff7f00;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;display:inline-block;margin-right:8px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .loading-text{color:#ff7f00}
    #qr-reader-container{width:100%;max-width:450px;display:none;margin-top:20px;padding:10px;border:1px solid #e0e0e0;border-radius:8px;margin-left:auto;margin-right:auto}
    .camera-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .camera-select{flex:1}
    .hint{font-size:12px;color:#777;margin-top:6px}
  </style>

  <!-- ตัวโหลดไลบรารี HTML5-QRCode สำหรับการสแกน QR Code -->
  <script>
    (function loadHtml5QrcodeWithFallback(){
      const cdns = [
        "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js",
        "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
      ];
      let i = 0;
      function tryNext(){
        if(i >= cdns.length){ console.error("ไม่สามารถโหลดไลบรารีสแกน QR ได้จากทุกแหล่ง"); return; }
        const s = document.createElement("script");
        s.src = cdns[i++];
        s.async = false;
        s.crossOrigin = "anonymous";
        s.onload = () => { if(window.Html5Qrcode) init(); else tryNext(); };
        s.onerror = tryNext;
        document.head.appendChild(s);
      }
      tryNext();
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Search & Check-In</h1></div>

    <div class="search-box">
      <!-- **ATTENTION:** Please replace this URL with your deployed Google Apps Script URL. -->
      <!-- The previous file used: https://script.google.com/macros/s/AKfycby_63E2g_MjI1ZljtI6XGryWmxcsrxFUTDtAEWS7mIo7VgDgZ2rhbOtVNWzIPhI46ky/exec -->
      <form id="searchForm">
        <div class="search-inputs">
          <div class="input-group">
            <label for="query">ค้นหา:</label>
            <input type="text" id="query" name="query" placeholder="ชื่อ, นามสกุล, บริษัท, เบอร์มือถือ, email, code" required>
          </div>
          <div class="action-buttons">
            <button type="button" class="btn-scan" id="btn-scan-qr">สแกน QR</button>
            <button type="submit" class="btn-search">ค้นหา</button>
          </div>
        </div>
      </form>
      <p class="search-info">*โปรดป้อนข้อมูลที่ต้องการค้นหาเพียงอย่างเดียว หรือใช้ปุ่ม "สแกน QR"</p>
      <div id="status-message"></div>

      <div id="qr-reader-container">
        <div class="camera-toolbar">
          <select id="cameraSelect" class="camera-select"></select>
          <button type="button" id="btn-reload-cams">รีเฟรชกล้อง</button>
        </div>
        <div id="qr-reader" style="width:100%"></div>
        <div class="hint">ถ้าค้างที่ “กำลังโหลดกล้อง” ตรวจสิทธิ์กล้องของเบราว์เซอร์ (ต้องเป็น HTTPS และกด “อนุญาต”)</div>
      </div>
    </div>

    <div id="results-container"></div>
  </div>

  <script>
    // === CONFIG ===
    // **โปรดเปลี่ยน URL นี้เป็น URL ของ Google Apps Script ที่ Deploy แล้วของคุณ**
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyf3NQFtglM5ZZz_x_HNHggKzVt3VD-IffoBFbgOf0oqTtQfPUsCGMOcdrSePBPheTm/exec"; 

    // ฟังก์ชันหลัก จะถูกเรียกเมื่อไลบรารีโหลดสำเร็จ
    function init(){
      // guard กล้องบน HTTPS/localhost เท่านั้น
      const isSecure = location.protocol === "https:" || location.hostname === "localhost";
      if(!isSecure){
        console.warn("การสแกนกล้องควรเปิดผ่าน HTTPS หรือ localhost เท่านั้น");
      }

      const form = document.getElementById('searchForm');
      const queryInput = document.getElementById('query');
      const resultsContainer = document.getElementById('results-container');
      const statusMessage = document.getElementById('status-message');
      const btnScan = document.getElementById('btn-scan-qr');
      const qrReaderContainer = document.getElementById('qr-reader-container');
      const cameraSelect = document.getElementById('cameraSelect');
      const btnReloadCams = document.getElementById('btn-reload-cams');

      let html5QrCode = null;
      let isScanning = false;
      let lastCameraId = null;

      // === Check-In Function ===
      function checkIn(memberCode, memberName){
        statusMessage.innerHTML = `<span class="spinner"></span><span class="loading-text">กำลังบันทึกการ Check-In ของ ${memberName}...</span>`;

        const formData = new FormData();
        formData.append('action', 'checkin'); // Action สำหรับ Apps Script
        formData.append('code', memberCode); // Code สมาชิก
        
        // ใช้ setTimeout เพื่อหลีกเลี่ยงการถูกบล็อก
        setTimeout(() => {
          fetch(APPS_SCRIPT_URL, { method:'POST', body:formData })
            .then(r => r.json())
            .then(data => {
              if (data.status === 'success'){
                // ใช้ Modal/Alert เพื่อแจ้งสถานะ
                alert(`Check-In สำเร็จ!\nชื่อ: ${memberName}\nเวลา: ${data.timestamp}\n\nสถานะ: ${data.message}`);
                // ค้นหาข้อมูลเดิมอีกครั้งเพื่ออัปเดตสถานะในหน้าจอ
                performSearch(queryInput.value); 
              } else {
                // แสดงข้อความผิดพลาดจาก Apps Script
                alert(`Check-In ล้มเหลว: ${data.message || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ'}`);
              }
            })
            .catch(err => {
              alert('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อ Check-In (โปรดตรวจสอบ Network)');
              console.error('Check-In Fetch Error:', err);
            })
            .finally(() => {
              // ล้างสถานะการโหลด
              statusMessage.textContent = '';
            });
        }, 100);
      }

      // === Render and Confirmation Logic ===
      function renderResults(items, queryValue){
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = '';
        
        let firstUncheckedItem = null; // เก็บรายการแรกที่ยังไม่ได้ Check-In
        
        items.forEach((item, idx)=>{
          // กำหนด class ตามสถานะ
          const statusClass = item.status && item.status.toLowerCase().includes('check in') ? 'status-checked-in' : 'status-pending';
          const statusText = item.status || 'Pending';
          
          const box = document.createElement('div');
          box.className = 'result-box';
          box.innerHTML = `
            <div class="result-title"><span>${idx+1}</span> ข้อมูลสมาชิก</div>
            <div class="data-list">
              <div class="data-row"><div class="data-label">สถานะ:</div><div class="data-value ${statusClass}">${statusText}</div></div>
              <div class="data-row"><div class="data-label">ชื่อ:</div><div class="data-value">${item.name||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">นามสกุล:</div><div class="data-value">${item.surname||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">ตำแหน่ง:</div><div class="data-value">${item.position||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">บริษัท:</div><div class="data-value">${item.company||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">เบอร์โทรศัพท์:</div><div class="data-value">${item.mobile||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">อีเมล:</div><div class="data-value">${item.email||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">Code ลงทะเบียน:</div><div class="data-value">${item.code||'ไม่ระบุ'}</div></div>
            </div>`;
          resultsContainer.appendChild(box);
          
          // ตรวจสอบรายการแรกที่ยังไม่ Check In สำหรับ Popup
          if (idx === 0 && item.code && !statusText.toLowerCase().includes('check in')) {
              firstUncheckedItem = item;
          }
        });
        
        // **POPUP CHECK-IN CONFIRMATION (ตามคำขอ)**
        if(firstUncheckedItem){ 
          const memberName = `${firstUncheckedItem.name||''} ${firstUncheckedItem.surname||''}`.trim() || 'สมาชิกท่านนี้';
          
          // ใช้ confirm() เพื่อถามผู้ใช้
          const confirmCheckIn = confirm(`พบข้อมูล: ${memberName}\n\nต้องการ Check-In ใช่หรือไม่?`);
          
          if(confirmCheckIn){
            // เรียกฟังก์ชัน Check-In หากผู้ใช้เลือก 'ใช่'
            checkIn(firstUncheckedItem.code, memberName);
          }
        }
      }

      // === Search Function ===
      function performSearch(queryValue){
        statusMessage.innerHTML = '<span class="spinner"></span><span class="loading-text">กำลังค้นหา...</span>';
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';

        const formData = new FormData();
        formData.append('query', queryValue);
        formData.append('action', 'search'); // ระบุ action

        fetch(APPS_SCRIPT_URL, { method:'POST', body:formData })
          .then(r=>r.json())
          .then(data=>{
            statusMessage.textContent = '';
            let items = data.data && Array.isArray(data.data) ? data.data : [];

            if (items.length > 0){
              renderResults(items, queryValue);
            } else {
              alert(data.message || 'ไม่พบข้อมูลตามที่ค้นหา');
            }
          })
          .catch(err=>{
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อ (โปรดตรวจสอบ URL และ Network)');
            console.error('Search Fetch Error:', err);
            statusMessage.textContent = '';
          });
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const queryValue = queryInput.value.trim();
        if(!queryValue) return;

        await stopScannerIfAny();
        performSearch(queryValue);
      });

      // === QR SCAN Logic (เหมือนเดิม) ===
      btnScan.addEventListener('click', async ()=>{
        if (isScanning){
          await stopScannerIfAny();
          qrReaderContainer.style.display = 'none';
          btnScan.textContent = 'สแกน QR';
          statusMessage.textContent = '';
          return;
        }

        qrReaderContainer.style.display = 'block';
        btnScan.textContent = 'ยกเลิกสแกน';
        statusMessage.innerHTML = '<span class="loading-text">กำลังเปิดกล้อง...</span>';

        try{
          const cams = await loadCameras();
          populateCameraSelect(cams);
          const preferred = pickBackCamera(cams) || cams[0];
          cameraSelect.value = preferred.id;
          await startScanner(preferred.id);
          statusMessage.textContent = '';
        }catch(err){
          alert(normalizeCamError(err));
          await stopScannerIfAny();
          qrReaderContainer.style.display = 'none';
          btnScan.textContent = 'สแกน QR';
          statusMessage.textContent = '';
        }
      });

      btnReloadCams.addEventListener('click', async ()=>{
        try{
          const cams = await loadCameras();
          populateCameraSelect(cams);
        }catch(err){
          alert('รีเฟรชกล้องไม่สำเร็จ: ' + (err?.message||err));
        }
      });

      cameraSelect.addEventListener('change', async ()=>{
        const devId = cameraSelect.value;
        if (!devId) return;
        try{
          await startScanner(devId);
          statusMessage.textContent = '';
        }catch(err){
          alert(normalizeCamError(err));
        }
      });

      function populateCameraSelect(cameras){
        cameraSelect.innerHTML = '';
        cameras.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.label || `Camera ${c.id}`;
          cameraSelect.appendChild(opt);
        });
      }

      async function loadCameras(){
        const cams = await Html5Qrcode.getCameras({ facingMode:"environment", includeLabels:true });
        if (!cams || cams.length === 0) throw new Error('NotFoundError');
        return cams.map(c=>({ id:c.id || c.deviceId, label:c.label || '', raw:c }));
      }

      function pickBackCamera(cameras){
        return cameras.find(c=>/back|rear|environment/i.test(c.label)) || null;
      }

      async function startScanner(deviceId){
        await stopScannerIfAny();
        if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
        const onSuccess = async (decodedText)=>{
          try{ await stopScannerIfAny(); }catch{}
          qrReaderContainer.style.display = 'none';
          btnScan.textContent = 'สแกน QR';
          statusMessage.textContent = '';
          queryInput.value = decodedText;
          performSearch(decodedText);
        };
        await html5QrCode.start(
          { deviceId:{ exact:deviceId } },
          { fps:10, qrbox:{ width:250, height:250 } },
          onSuccess
        );
        isScanning = true;
        lastCameraId = deviceId;
      }

      async function stopScannerIfAny(){
        if (html5QrCode && isScanning){
          try{ await html5QrCode.stop(); }
          catch(e){ console.warn('Stop scanner error:', e); }
          finally{ isScanning = false; }
        }
      }

      function normalizeCamError(err){
        const name = err?.name || err?.message || String(err);
        if (name.includes('NotAllowedError') || name.includes('PermissionDenied')) return 'เข้าถึงกล้องถูกปฏิเสธ: โปรดอนุญาตการใช้งานกล้องสำหรับเว็บไซต์นี้ (ต้องเป็น HTTPS)';
        if (name.includes('NotFoundError')) return 'ไม่พบกล้องในอุปกรณ์นี้';
        if (name.includes('NotReadableError')) return 'กล้องถูกใช้งานโดยแอปอื่นอยู่ โปรดปิดแอปกล้อง/แอปอื่นก่อน';
        if (name.includes('OverconstrainedError')) return 'ข้อจำกัดของกล้องไม่รองรับ ลองเลือกกล้องตัวอื่น';
        return 'เกิดข้อผิดพลาดในการเริ่มกล้อง: ' + (err?.message || err);
      }

      document.addEventListener('visibilitychange', async ()=>{
        if (document.hidden){
          await stopScannerIfAny();
        } else if (qrReaderContainer.style.display === 'block' && lastCameraId){
          try{ await startScanner(lastCameraId); }catch(e){ console.warn('Restart failed:', e); }
        }
      });

      window.addEventListener('beforeunload', async ()=>{ await stopScannerIfAny(); });
    }
  </script>
</body>
</html>


