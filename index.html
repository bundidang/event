<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search & Check-In</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Prompt','Tahoma','Arial',sans-serif;background:#f0f2f5;display:flex;flex-direction:column;align-items:center;padding:20px;color:#333}
    .container{width:100%;max-width:800px;margin:0 auto}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#1a1a1a;font-size:28px;margin-bottom:5px}
    .search-box{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:40px;text-align:center}
    .search-inputs{display:flex;flex-direction:column;gap:10px;margin-bottom:15px;align-items:center}
    .input-group{display:flex;align-items:center;background:#fff;padding:10px 15px;border-radius:8px;border:1px solid #e0e0e0;width:100%;max-width:450px}
    .input-group label{color:#ff7f00;font-weight:bold;margin-right:10px}
    .input-group input{border:none;outline:none;flex-grow:1;font-size:16px;padding:5px 0;background:transparent;color:#333}
    .action-buttons{display:flex;gap:10px;justify-content:center;width:100%;max-width:450px}
    .btn-search,.btn-scan{color:#fff;padding:15px 25px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:background-color .3s;flex-grow:1}
    .btn-search{background:#ff7f00}.btn-search:hover{background:#cc6600}
    .btn-scan{background:#4CAF50}.btn-scan:hover{background:#45a049}
    #results-container{margin-top:20px;display:none}
    .result-box{background:#fff;padding:20px 30px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);text-align:left;margin-bottom:15px}
    .result-title{display:flex;align-items:center;font-size:20px;font-weight:bold;color:#1a1a1a;border-bottom:2px solid #e0e0e0;padding-bottom:10px;margin-bottom:20px}
    .result-title span{background:#ff7f00;color:#fff;border-radius:50%;width:25px;height:25px;display:flex;justify-content:center;align-items:center;font-size:16px;margin-right:10px}
    .data-row{display:flex;padding:8px 0;border-bottom:1px dashed #e9ecef;font-size:15px;align-items:flex-start}
    .data-label{width:150px;color:#555;flex-shrink:0}
    .data-value{font-weight:bold;color:#333;flex-grow:1;word-break: break-word}
    .status-checked-in{color:#4CAF50;font-weight:bold}
    .status-pending{color:#ff7f00;font-weight:bold}
    #status-message{margin-top:20px;font-size:15px;font-weight:600;color:#6b7280}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #ff7f00;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;display:inline-block;margin-right:8px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #qr-reader-container{width:100%;max-width:450px;display:none;margin:20px auto;padding:10px;border:1px solid #e0e0e0;border-radius:8px}

    /* Custom Modal สำหรับการแสดงผลตัวหนา */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: white; padding: 25px; border-radius: 15px; max-width: 400px; width: 90%; text-align: center;
    }
    .modal-content h3 { margin-top: 0; color: #333; }
    .modal-info { margin: 20px 0; line-height: 1.6; font-size: 17px; }
    .modal-info strong { color: #000; font-weight: 700; }
    .modal-btns { display: flex; gap: 10px; justify-content: center; }
    .btn-ok { background: #007bff; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-cancel { background: #6c757d; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; }

    @media (max-width: 600px) {
      .data-row {flex-direction: column;align-items: stretch}
      .data-label {width: auto;margin-bottom: 2px}
      .data-value {padding-left: 15px;font-size: 16px}
    }
  </style>

  <script>
    (function loadHtml5QrcodeWithFallback(){
      const cdns = ["https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js","https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"];
      let i = 0;
      function tryNext(){
        if(i >= cdns.length) return;
        const s = document.createElement("script");
        s.src = cdns[i++];
        s.onload = () => { if(window.Html5Qrcode) init(); else tryNext(); };
        s.onerror = tryNext;
        document.head.appendChild(s);
      }
      tryNext();
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Search & Check-In</h1></div>
    <div class="search-box">
      <form id="searchForm">
        <div class="search-inputs">
          <div class="input-group">
            <label for="query">ค้นหา:</label>
            <input type="text" id="query" name="query" placeholder="ชื่อ, นามสกุล, บริษัท, เบอร์มือถือ, email, code" required>
          </div>
          <div class="action-buttons">
            <button type="button" class="btn-scan" id="btn-scan-qr">สแกน QR</button>
            <button type="submit" class="btn-search">ค้นหา</button>
          </div>
        </div>
      </form>
      <div id="status-message"></div>
      <div id="qr-reader-container">
        <div id="qr-reader" style="width:100%"></div>
      </div>
    </div>
    <div id="results-container"></div>
  </div>

  <div id="checkinModal" class="modal-overlay">
    <div class="modal-content">
      <h3>พบข้อมูล</h3>
      <div id="modalInfo" class="modal-info"></div>
      <p>ต้องการ Check-In ใช่หรือไม่?</p>
      <div class="modal-btns">
        <button id="modalCancel" class="btn-cancel">Cancel</button>
        <button id="modalOk" class="btn-ok">OK</button>
      </div>
    </div>
  </div>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwOXKcZBj1CZDLdemL4-XsxA9wCNql3FAtV1zvxW_WIOLOl5k4nLkNrqDfDPys5-hn0/exec"; 

    function init(){
      const queryInput = document.getElementById('query');
      const resultsContainer = document.getElementById('results-container');
      const statusMessage = document.getElementById('status-message');
      const btnScan = document.getElementById('btn-scan-qr');
      const qrReaderContainer = document.getElementById('qr-reader-container');
      
      const modal = document.getElementById('checkinModal');
      const modalInfo = document.getElementById('modalInfo');
      const modalOk = document.getElementById('modalOk');
      const modalCancel = document.getElementById('modalCancel');

      let html5QrCode = null;
      let isScanning = false;
      let currentPendingItem = null;

      function checkInSilently(memberCode, companyName){
        const formData = new FormData();
        formData.append('action', 'checkin');
        formData.append('code', memberCode);
        formData.append('company', companyName || '');
        fetch(APPS_SCRIPT_URL, { method:'POST', body:formData }).catch(err => console.error(err));
      }

      function showCheckinModal(item) {
        currentPendingItem = item;
        const name = `${item.name||''} ${item.surname||''}`.trim();
        const pos = item.position || '';
        const comp = item.company || '';
        
        // ใส่ Tag <strong> เพื่อให้ ชื่อ-นามสกุล และ บริษัท เป็นตัวหนา
        modalInfo.innerHTML = `
          <strong>${name}</strong><br>
          ${pos ? pos + '<br>' : ''}
          <strong>${comp}</strong>
        `;
        modal.style.display = 'flex';
      }

      modalOk.onclick = () => {
        if(currentPendingItem) {
          checkInSilently(currentPendingItem.code, currentPendingItem.company);
          modal.style.display = 'none';
          resultsContainer.innerHTML = '';
          resultsContainer.style.display = 'none';
          queryInput.value = '';
          btnScan.click();
        }
      };

      modalCancel.onclick = () => { modal.style.display = 'none'; };

      function renderResults(items){
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = '';
        let firstUncheckedItem = null;
        
        items.forEach((item, idx)=>{
          const statusText = item.status || 'Pending';
          const isChecked = statusText.toLowerCase().includes('check in');
          const statusClass = isChecked ? 'status-checked-in' : 'status-pending';
          const fullName = `${item.name||''} ${item.surname||''}`.trim();

          const box = document.createElement('div');
          box.className = 'result-box';
          box.innerHTML = `
            <div class="result-title"><span>${idx+1}</span> ข้อมูลสมาชิก</div>
            <div class="data-list">
              <div class="data-row"><div class="data-label">สถานะ:</div><div class="data-value ${statusClass}">${statusText}</div></div>
              <div class="data-row"><div class="data-label">ชื่อ-นามสกุล:</div><div class="data-value">${fullName}</div></div>
              <div class="data-row"><div class="data-label">ตำแหน่ง:</div><div class="data-value">${item.position||'-'}</div></div>
              <div class="data-row"><div class="data-label">บริษัท:</div><div class="data-value">${item.company||'-'}</div></div>
              <div class="data-row"><div class="data-label">Code:</div><div class="data-value">${item.code||'-'}</div></div>
            </div>`;
          resultsContainer.appendChild(box);
          if (idx === 0 && !isChecked) firstUncheckedItem = item;
        });
        
        if(firstUncheckedItem) showCheckinModal(firstUncheckedItem);
      }

      function performSearch(queryValue){
        statusMessage.innerHTML = '<span class="spinner"></span> <span>กำลังค้นหา...</span>';
        const formData = new FormData();
        formData.append('query', queryValue);
        formData.append('action', 'search');

        fetch(APPS_SCRIPT_URL, { method:'POST', body:formData })
          .then(r=>r.json())
          .then(data=>{
            statusMessage.textContent = '';
            if (data.data && data.data.length > 0) renderResults(data.data);
            else alert('ไม่พบข้อมูล');
          })
          .catch(() => { statusMessage.textContent = ''; alert('การเชื่อมต่อขัดข้อง'); });
      }

      document.getElementById('searchForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        if(queryInput.value.trim()) performSearch(queryInput.value.trim());
      });

      btnScan.addEventListener('click', async ()=>{
        if (isScanning){ await stopScanner(); btnScan.textContent = 'สแกน QR'; return; }
        qrReaderContainer.style.display = 'block';
        btnScan.textContent = 'ยกเลิกสแกน';
        try {
          const cams = await Html5Qrcode.getCameras();
          const backCam = cams.find(c=>/back|rear|environment/i.test(c.label)) || cams[0];
          if(!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
          await html5QrCode.start(backCam.id, { fps:10, qrbox:250 }, (text)=>{
            stopScanner();
            queryInput.value = text;
            performSearch(text);
          });
          isScanning = true;
        } catch(e) { alert('ไม่สามารถเปิดกล้องได้'); }
      });

      async function stopScanner(){
        if(html5QrCode && isScanning){ await html5QrCode.stop(); isScanning = false; qrReaderContainer.style.display = 'none'; }
      }
    }
  </script>
</body>
</html>
