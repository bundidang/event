<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search & Check-In</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Prompt','Tahoma','Arial',sans-serif;background:#f0f2f5;display:flex;flex-direction:column;align-items:center;padding:20px;color:#333}
    .container{width:100%;max-width:800px;margin:0 auto}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#1a1a1a;font-size:28px;margin-bottom:5px}
    .search-box{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:40px;text-align:center}
    .search-inputs{display:flex;flex-direction:column;gap:10px;margin-bottom:15px;align-items:center}
    .input-group{display:flex;align-items:center;background:#fff;padding:10px 15px;border-radius:8px;border:1px solid #e0e0e0;width:100%;max-width:450px}
    .input-group label{color:#ff7f00;font-weight:bold;margin-right:10px}
    .input-group input{border:none;outline:none;flex-grow:1;font-size:16px;padding:5px 0;background:transparent;color:#333}
    .action-buttons{display:flex;gap:10px;justify-content:center;width:100%;max-width:450px}
    .btn-search,.btn-scan{color:#fff;padding:15px 25px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:background-color .3s;flex-grow:1}
    .btn-search{background:#ff7f00}.btn-search:hover{background:#cc6600}
    .btn-scan{background:#4CAF50}.btn-scan:hover{background:#45a049}
    #results-container{display:none;margin-top:20px}
    .result-box{background:#fff;padding:20px 30px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);text-align:left;margin-bottom:15px}
    .result-title{display:flex;align-items:center;font-size:20px;font-weight:bold;color:#1a1a1a;border-bottom:2px solid #e0e0e0;padding-bottom:10px;margin-bottom:20px}
    .result-title span{background:#ff7f00;color:#fff;border-radius:50%;width:25px;height:25px;display:flex;justify-content:center;align-items:center;font-size:16px;margin-right:10px}
    .data-row{display:flex;padding:8px 0;border-bottom:1px dashed #e9ecef;font-size:15px}
    .data-label{width:180px;color:#555;flex-shrink:0}
    .data-value{font-weight:bold;color:#333;flex-grow:1}
    .status-checked-in{color:#4CAF50}.status-pending{color:#ff7f00}
    #status-message{margin-top:20px;font-size:15px;font-weight:600;color:#6b7280}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #ff7f00;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;display:inline-block;margin-right:8px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #qr-reader-container{width:100%;max-width:450px;display:none;margin:20px auto;border:1px solid #e0e0e0;border-radius:8px;padding:10px}
    @media (max-width: 600px) {
        .data-row {flex-direction: column;}
        .data-label {width: auto; margin-bottom: 2px;}
    }
  </style>

  <script>
    // Load Library Check
    (function loadHtml5Qrcode(){
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js";
      script.onload = () => init();
      document.head.appendChild(script);
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Search & Check-In</h1></div>
    <div class="search-box">
      <form id="searchForm">
        <div class="search-inputs">
          <div class="input-group">
            <label for="query">ค้นหา:</label>
            <input type="text" id="query" name="query" placeholder="ชื่อ, นามสกุล, บริษัท..." required>
          </div>
          <div class="action-buttons">
            <button type="button" class="btn-scan" id="btn-scan-qr">สแกน QR</button>
            <button type="submit" class="btn-search">ค้นหา</button>
          </div>
        </div>
      </form>
      <div id="status-message"></div>
      <div id="qr-reader-container">
        <div id="qr-reader" style="width:100%"></div>
      </div>
    </div>
    <div id="results-container"></div>
  </div>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwOXKcZBj1CZDLdemL4-XsxA9wCNql3FAtV1zvxW_WIOLOl5k4nLkNrqDfDPys5-hn0/exec"; 

    function init(){
      const queryInput = document.getElementById('query');
      const resultsContainer = document.getElementById('results-container');
      const statusMessage = document.getElementById('status-message');
      const btnScan = document.getElementById('btn-scan-qr');
      const qrReaderContainer = document.getElementById('qr-reader-container');

      let html5QrCode = null;
      let isScanning = false;

      // === บันทึกเช็คอินเบื้องหลัง ===
      function checkInSilently(memberCode, companyName){
        const formData = new FormData();
        formData.append('action', 'checkin');
        formData.append('code', memberCode);
        formData.append('company', companyName || '');
        
        fetch(APPS_SCRIPT_URL, { method:'POST', body:formData })
          .then(r => r.json())
          .then(data => { if(data.status !== 'success') alert('บันทึกล้มเหลว: ' + data.message); })
          .catch(err => console.error('Check-In Error:', err));
      }

      function renderResults(items){
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = '';
        let firstUncheckedItem = null;
        
        items.forEach((item, idx)=>{
          const statusText = item.status || 'Pending';
          const isChecked = statusText.toLowerCase().includes('check in');
          const fullName = `${item.name||''} ${item.surname||''}`.trim();

          const box = document.createElement('div');
          box.className = 'result-box';
          box.innerHTML = `
            <div class="result-title"><span>${idx+1}</span> ข้อมูลสมาชิก</div>
            <div class="data-list">
              <div class="data-row"><div class="data-label">สถานะ:</div><div class="data-value ${isChecked?'status-checked-in':'status-pending'}">${statusText}</div></div>
              <div class="data-row"><div class="data-label">ชื่อ-นามสกุล:</div><div class="data-value">${fullName}</div></div>
              <div class="data-row"><div class="data-label">ตำแหน่ง:</div><div class="data-value">${item.position||'ไม่ระบุ'}</div></div>
              <div class="data-row"><div class="data-label">บริษัท:</div><div class="data-value">${item.company||'ไม่ระบุ'}</div></div>
            </div>`;
          resultsContainer.appendChild(box);
          
          if (idx === 0 && !isChecked) firstUncheckedItem = item;
        });
        
        // Popup พร้อมแสดงตำแหน่ง (Position)
        if(firstUncheckedItem){ 
          const name = `${firstUncheckedItem.name||''} ${firstUncheckedItem.surname||''}`.trim();
          const pos = firstUncheckedItem.position || 'ไม่ระบุตำแหน่ง';
          const comp = firstUncheckedItem.company || '';
          
          // ข้อความใน Popup (เพิ่มตำแหน่ง)
          const confirmMsg = `พบข้อมูล\n${name}\n${pos}\n${comp}\n\nต้องการ Check-In ใช่หรือไม่?`;
          
          if(confirm(confirmMsg)){
            checkInSilently(firstUncheckedItem.code, comp);
            // จบขั้นตอนทันที: ล้างค่าและเปิดกล้องต่อ
            queryInput.value = '';
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            btnScan.click(); 
          }
        }
      }

      function performSearch(queryValue){
        statusMessage.innerHTML = '<span class="spinner"></span> ค้นหา...';
        const formData = new FormData();
        formData.append('query', queryValue);
        formData.append('action', 'search');

        fetch(APPS_SCRIPT_URL, { method:'POST', body:formData })
          .then(r=>r.json())
          .then(data=>{
            statusMessage.textContent = '';
            if (data.data && data.data.length > 0) renderResults(data.data);
            else alert('ไม่พบข้อมูล');
          })
          .catch(() => { statusMessage.textContent = ''; alert('การเชื่อมต่อขัดข้อง'); });
      }

      document.getElementById('searchForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        performSearch(queryInput.value.trim());
      });

      btnScan.addEventListener('click', async ()=>{
        if (isScanning){ await html5QrCode.stop(); isScanning = false; qrReaderContainer.style.display = 'none'; btnScan.textContent = 'สแกน QR'; return; }
        qrReaderContainer.style.display = 'block';
        btnScan.textContent = 'ยกเลิกสแกน';
        if(!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
        await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
          html5QrCode.stop().then(() => {
            isScanning = false;
            qrReaderContainer.style.display = 'none';
            btnScan.textContent = 'สแกน QR';
            queryInput.value = text;
            performSearch(text);
          });
        });
        isScanning = true;
      });
    }
  </script>
</body>
</html>
