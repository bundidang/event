<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Event Smart Search By Supermink</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.minified.js"></script>

  <style>
    body{font-family:'Prompt','Tahoma','Arial',sans-serif;background:#f0f2f5;display:flex;flex-direction:column;align-items:center;padding:20px;color:#333}
    .container{width:100%;max-width:800px;margin:0 auto}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#1a1a1a;font-size:28px;margin-bottom:5px}
    .search-box{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:40px;text-align:center}
    .search-inputs{display:flex;flex-direction:column;gap:10px;margin-bottom:15px;align-items:center}
    .input-group{display:flex;align-items:center;background:#fff;padding:10px 15px;border-radius:8px;border:1px solid #e0e0e0;width:100%;max-width:450px}
    .input-group label{color:#ff7f00;font-weight:bold;margin-right:10px}
    .input-group input{border:none;outline:none;flex-grow:1;font-size:16px;padding:5px 0;background:transparent;color:#333}
    .action-buttons{display:flex;gap:10px;justify-content:center;width:100%;max-width:450px}
    .btn-search,.btn-scan{color:#fff;padding:15px 25px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:background-color .3s;flex-grow:1}
    .btn-search{background:#ff7f00}.btn-search:hover{background:#cc6600}
    .btn-scan{background:#4CAF50}.btn-scan:hover{background:#45a049}
    .search-info{color:#999;font-size:14px;margin-top:10px}
    #results-container{max-height:400px;overflow-y:auto;padding:10px;border:1px solid #cccccc40;border-radius:8px;margin-top:20px;display:none}
    .result-box{background:#fff;padding:20px 30px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);text-align:left;margin-bottom:15px}
    .result-title{display:flex;align-items:center;font-size:20px;font-weight:bold;color:#1a1a1a;border-bottom:2px solid #e0e0e0;padding-bottom:10px;margin-bottom:20px}
    .result-title span{background:#ff7f00;color:#fff;border-radius:50%;width:25px;height:25px;display:flex;justify-content:center;align-items:center;font-size:16px;margin-right:10px}
    .data-row{display:flex;padding:8px 0;border-bottom:1px dashed #e9ecef;font-size:15px}
    .data-label{width:180px;color:#555}
    .data-value{font-weight:bold;color:#333;flex-grow:1}
    #status-message{margin-top:20px;font-size:16px;font-weight:bold;color:#dc3545}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #ff7f00;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;display:inline-block;margin-right:8px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .loading-text{color:#ff7f00}
    #qr-reader-container{width:100%;max-width:450px;display:none;margin-top:20px;padding:10px;border:1px solid #e0e0e0;border-radius:8px;margin-left:auto;margin-right:auto}
    .camera-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .camera-select{flex:1}
    .hint{font-size:12px;color:#777;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Smart Search</h1></div>

    <div class="search-box">
      <!-- ใช้ URL เดียวกันทั้ง form action และ APPS_SCRIPT_URL -->
      <form id="searchForm" action="https://script.google.com/macros/s/AKfycbw49pZZBFFXLNn43BfRDPEkMlY6vwQKFjygwTK5jLpXKPh12ATntltgbtJeW7jOnopm/exec" method="POST">
        <div class="search-inputs">
          <div class="input-group">
            <label for="query">ค้นหา:</label>
            <input type="text" id="query" name="query" placeholder="ชื่อ, นามสกุล, บริษัท, เบอร์มือถือ, email, code" required>
          </div>
          <div class="action-buttons">
            <button type="button" class="btn-scan" id="btn-scan-qr">สแกน QR</button>
            <button type="submit" class="btn-search">ค้นหา</button>
          </div>
        </div>
      </form>
      <p class="search-info">*โปรดป้อนข้อมูลที่ต้องการค้นหาเพียงอย่างเดียว หรือใช้ปุ่ม "สแกน QR"</p>
      <div id="status-message"></div>

      <div id="qr-reader-container">
        <div class="camera-toolbar">
          <select id="cameraSelect" class="camera-select"></select>
          <button type="button" id="btn-reload-cams">รีเฟรชกล้อง</button>
        </div>
        <div id="qr-reader" style="width:100%"></div>
        <div class="hint">หากค้างที่ “กำลังโหลดกล้อง” ให้ตรวจสิทธิ์กล้องในเบราว์เซอร์ (ต้องเป็น HTTPS และกด “อนุญาต”) โดยเฉพาะ iOS Safari</div>
      </div>
    </div>

    <div id="results-container"></div>
  </div>

  <script>
    // === CONFIG ===
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw49pZZBFFXLNn43BfRDPEkMlY6vwQKFjygwTK5jLpXKPh12ATntltgbtJeW7jOnopm/exec";

    // === DOM ===
    const form = document.getElementById('searchForm');
    const queryInput = document.getElementById('query');
    const resultsContainer = document.getElementById('results-container');
    const statusMessage = document.getElementById('status-message');
    const btnScan = document.getElementById('btn-scan-qr');
    const qrReaderContainer = document.getElementById('qr-reader-container');
    const cameraSelect = document.getElementById('cameraSelect');
    const btnReloadCams = document.getElementById('btn-reload-cams');

    let html5QrCode = null;
    let isScanning = false;
    let lastCameraId = null;

    // === SEARCH ===
    function performSearch(queryValue) {
      statusMessage.innerHTML = '<span class="spinner"></span><span class="loading-text">กำลังค้นหา...</span>';
      resultsContainer.style.display = 'none';
      resultsContainer.innerHTML = '';

      const formData = new FormData();
      formData.append('query', queryValue);

      fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
          statusMessage.textContent = '';
          let items;
          if (data.data && Array.isArray(data.data)) items = data.data;
          else if (data.status === 'success' && data.name) items = [data];
          else items = [];

          if (items.length > 0) {
            resultsContainer.style.display = 'block';
            items.forEach((item, idx) => {
              const box = document.createElement('div');
              box.className = 'result-box';
              box.innerHTML = `
                <div class="result-title"><span>${idx+1}</span> ข้อมูลสมาชิก</div>
                <div class="data-list">
                  <div class="data-row"><div class="data-label">ชื่อ:</div><div class="data-value">${item.name||'ไม่ระบุ'}</div></div>
                  <div class="data-row"><div class="data-label">นามสกุล:</div><div class="data-value">${item.surname||'ไม่ระบุ'}</div></div>
                  <div class="data-row"><div class="data-label">ตำแหน่ง:</div><div class="data-value">${item.position||'ไม่ระบุ'}</div></div>
                  <div class="data-row"><div class="data-label">บริษัท:</div><div class="data-value">${item.company||'ไม่ระบุ'}</div></div>
                  <div class="data-row"><div class="data-label">เบอร์โทรศัพท์:</div><div class="data-value">${item.mobile||'ไม่ระบุ'}</div></div>
                  <div class="data-row"><div class="data-label">อีเมล:</div><div class="data-value">${item.email||'ไม่ระบุ'}</div></div>
                  <div class="data-row"><div class="data-label">Code ลงทะเบียน:</div><div class="data-value">${item.code||'ไม่ระบุ'}</div></div>
                </div>`;
              resultsContainer.appendChild(box);
            });
          } else {
            resultsContainer.style.display = 'none';
            statusMessage.innerHTML = data.message || 'ไม่พบข้อมูลตามที่ค้นหา';
          }
        })
        .catch(err => {
          resultsContainer.style.display = 'none';
          statusMessage.innerHTML = 'เกิดข้อผิดพลาดในการเชื่อมต่อ (โปรดตรวจสอบ URL และ Network)';
          console.error('Fetch error:', err);
        });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await stopScannerIfAny();
      performSearch(queryInput.value);
    });

    // === QR SCAN ===
    btnScan.addEventListener('click', async () => {
      if (isScanning) {
        await stopScannerIfAny();
        qrReaderContainer.style.display = 'none';
        btnScan.textContent = 'สแกน QR';
        statusMessage.textContent = '';
        return;
      }
      // เปิดกล่องกล้อง + โหลดรายการกล้อง
      qrReaderContainer.style.display = 'block';
      btnScan.textContent = 'ยกเลิกสแกน';
      statusMessage.innerHTML = '<span class="loading-text">กำลังโหลดกล้อง...</span>';

      try {
        const cams = await loadCameras();
        populateCameraSelect(cams);
        // เลือกกล้อง back/environment ถ้ามี
        const preferred = pickBackCamera(cams) || cams[0];
        cameraSelect.value = preferred.id;
        await startScanner(preferred.id);
        statusMessage.textContent = 'พร้อมสแกน... โปรดเล็งกล้องไปที่ QR Code';
      } catch (err) {
        handleStartError(err);
        await stopScannerIfAny();
        qrReaderContainer.style.display = 'none';
        btnScan.textContent = 'สแกน QR';
      }
    });

    btnReloadCams.addEventListener('click', async () => {
      try {
        const cams = await loadCameras(true);
        populateCameraSelect(cams);
      } catch (err) {
        alert('รีเฟรชกล้องไม่สำเร็จ: ' + (err?.message||err));
      }
    });

    cameraSelect.addEventListener('change', async () => {
      const devId = cameraSelect.value;
      if (!devId) return;
      try {
        await startScanner(devId);
        statusMessage.textContent = 'พร้อมสแกน... โปรดเล็งกล้องไปที่ QR Code';
      } catch (err) {
        handleStartError(err);
      }
    });

    function populateCameraSelect(cameras) {
      cameraSelect.innerHTML = '';
      cameras.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.label || `Camera ${c.id}`;
        cameraSelect.appendChild(opt);
      });
    }

    async function loadCameras(force = false) {
      // บางเบราว์เซอร์ต้องมี user gesture ถึงจะขอสิทธิ์ได้
      const cams = await Html5Qrcode.getCameras({ facingMode: "environment", includeLabels: true });
      if (!cams || cams.length === 0) throw new Error('NotFoundError');
      return cams.map(c => ({ id: c.id || c.deviceId, label: c.label || '', raw: c }));
    }

    function pickBackCamera(cameras) {
      // เลือกตัวที่ label บอกว่า back / rear / environment ก่อน
      return cameras.find(c => /back|rear|environment/i.test(c.label)) || null;
    }

    async function startScanner(deviceId) {
      await stopScannerIfAny();
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      const qrCodeSuccessCallback = async (decodedText) => {
        try {
          await stopScannerIfAny();
        } catch (_) {}
        qrReaderContainer.style.display = 'none';
        btnScan.textContent = 'สแกน QR';
        queryInput.value = decodedText;
        performSearch(decodedText);
      };
      // เริ่มด้วย deviceId ที่เลือก ช่วยลดเคสค้างโหลดบน iOS/Android
      await html5QrCode.start({ deviceId: { exact: deviceId } }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrCodeSuccessCallback);
      isScanning = true;
      lastCameraId = deviceId;
    }

    async function stopScannerIfAny() {
      if (html5QrCode && isScanning) {
        try {
          await html5QrCode.stop();
        } catch (e) {
          console.warn('Stop scanner error:', e);
        } finally {
          isScanning = false;
        }
      }
    }

    function handleStartError(err) {
      let msg;
      const name = err?.name || err?.message || String(err);
      if (name.includes('NotAllowedError') || name.includes('PermissionDenied')) {
        msg = 'เข้าถึงกล้องถูกปฏิเสธ: โปรดตรวจสิทธิ์กล้องของเบราว์เซอร์สำหรับเว็บไซต์นี้ (ต้องเป็น HTTPS และกด “อนุญาต”)';
      } else if (name.includes('NotFoundError')) {
        msg = 'ไม่พบกล้องในอุปกรณ์นี้';
      } else if (name.includes('NotReadableError')) {
        msg = 'กล้องถูกใช้งานโดยแอปอื่นอยู่ โปรดปิดแอปกล้อง/แอปอื่นก่อน';
      } else if (name.includes('OverconstrainedError')) {
        msg = 'ข้อจำกัดของกล้องไม่รองรับ ลองเลือกกล้องตัวอื่น';
      } else {
        msg = 'เกิดข้อผิดพลาดในการเริ่มกล้อง: ' + (err?.message || err);
      }
      statusMessage.innerHTML = `<span style="color:#dc3545;">${msg}</span>`;
      console.error('Error starting QR scanner:', err);
    }

    // หยุดกล้องเมื่อหน้าไม่โฟกัส ลดโอกาสค้าง
    document.addEventListener('visibilitychange', async () => {
      if (document.hidden) {
        await stopScannerIfAny();
      } else if (qrReaderContainer.style.display === 'block' && lastCameraId) {
        try {
          await startScanner(lastCameraId);
        } catch (e) {
          console.warn('Restart after visible failed:', e);
        }
      }
    });

    // ป้องกันเลื่อนจอระหว่างสแกนบนมือถือ -> ทำให้กล่องคงที่
    window.addEventListener('beforeunload', async () => { await stopScannerIfAny(); });
  </script>
</body>
</html>
